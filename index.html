<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>JUKEN‚òÖQUEST ‚Äì Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="problems.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00ffff;
            --neon-pink: #ff00ff;
            --neon-purple: #8b00ff;
            --neon-green: #00ff41;
            --neon-yellow: #ffff00;
            --dark-bg: #0a0a0f;
            --card-bg: rgba(15, 15, 25, 0.95);
            --glass-bg: rgba(255, 255, 255, 0.05);
        }

        body {
            font-family: "Noto Sans JP", sans-serif;
            background: linear-gradient(135deg, #0a0a0f 0%, #1a0a2e 50%, #0f3460 100%);
            min-height: 100vh;
            touch-action: manipulation;
            overflow-x: hidden;
        }

        .container-spacing {
            margin: 0 auto;
            max-width: 95%;
            width: 100%;
        }

        @media (min-width: 640px) {
            .container-spacing {
                max-width: 600px;
            }
        }

        @media (min-width: 768px) {
            .container-spacing {
                max-width: 768px;
            }
        }

        @media (min-width: 1024px) {
            .container-spacing {
                max-width: 1024px;
            }
        }

        .game-title {
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: clamp(1.6rem, 4.5vw, 3rem);
            background: linear-gradient(45deg, var(--neon-cyan), var(--neon-pink), var(--neon-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            letter-spacing: 0.1em;
        }

        .neon-card {
            background: var(--card-bg);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .neon-button {
            background: linear-gradient(45deg, rgba(0, 255, 255, 0.2), rgba(255, 0, 255, 0.2));
            border: 1px solid var(--neon-cyan);
            color: white;
            font-weight: 700;
            border-radius: 12px;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .neon-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 255, 255, 0.3);
            border-color: var(--neon-pink);
        }

        .neon-button:active {
            transform: translateY(0);
        }

        .upgrade-button {
            background: linear-gradient(135deg, rgba(255, 0, 100, 0.3), rgba(100, 0, 255, 0.3));
            border: 2px solid var(--neon-pink);
            position: relative;
            padding: 0.75rem 1rem !important;
            font-size: 0.9rem;
        }

        .upgrade-button .upgrade-title {
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .upgrade-button .upgrade-cost {
            font-size: 0.8rem;
        }

        .hp-bar {
            transition: width 0.3s ease;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-yellow), #ff4444);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .particle {
            position: absolute;
            pointer-events: none;
            font-weight: 900;
            z-index: 100;
            animation: particleFloat 2s ease-out forwards;
            font-size: 18px;
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-80px) scale(1.2);
                opacity: 0;
            }
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(0, 255, 65, 0.9), rgba(0, 200, 50, 0.9));
            color: white;
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid var(--neon-green);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
        }

        .notification.show {
            transform: translateX(0);
        }

        .subject-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            color: white;
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
            padding: 0.4rem 0.25rem;
            min-height: 55px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .subject-btn:hover {
            border-color: var(--neon-cyan);
            transform: translateY(-2px);
            background: rgba(0, 255, 255, 0.1);
        }

        .subject-btn.active {
            background: rgba(139, 92, 246, 0.3);
            border-color: var(--neon-purple);
            transform: translateY(-2px);
            color: white;
        }

        .category-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
            padding: 0.5rem 0.3rem;
            font-size: 0.8rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 50px;
            cursor: pointer;
        }

        .category-btn:hover {
            border-color: var(--neon-cyan);
            transform: translateY(-1px);
            background: rgba(0, 255, 255, 0.1);
            color: white;
        }

        .category-btn.active {
            background: rgba(0, 255, 255, 0.2);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            transform: translateY(-1px);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .grade-label {
            color: var(--neon-yellow);
            font-size: 0.75rem;
            font-weight: 700;
            text-align: center;
            margin: 0.75rem 0 0.5rem 0;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-shadow: 0 0 5px currentColor;
        }

        .floating-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--neon-purple), var(--neon-pink));
            border: 2px solid var(--neon-cyan);
            border-radius: 50%;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .floating-button:hover {
            transform: translateY(-3px);
        }

        .glow-text {
            color: var(--neon-cyan);
            text-shadow: 0 0 10px currentColor;
            font-weight: 700;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 10px;
            padding: 0.75rem;
            transition: all 0.2s ease;
        }

        .stat-item:hover {
            border-color: var(--neon-cyan);
        }

        .quiz-option {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid var(--neon-cyan);
            color: white;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.2s ease;
            font-weight: 600;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .quiz-option:hover {
            background: rgba(0, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .auto-quest-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 1rem;
        }

        .toggle-button {
            background: linear-gradient(135deg, rgba(255, 0, 100, 0.3), rgba(100, 0, 255, 0.3));
            border: 1px solid #ff0066;
            color: white;
            padding: 0.4rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .toggle-button.active {
            background: linear-gradient(135deg, rgba(0, 255, 100, 0.3), rgba(0, 200, 255, 0.3));
            border-color: #00ff66;
        }

        .time-selector {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            padding: 0.4rem;
            display: flex;
            gap: 0.25rem;
        }

        .time-option {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .time-option.active {
            background: var(--neon-cyan);
            border-color: var(--neon-cyan);
            color: black;
        }

        .time-option:hover {
            border-color: var(--neon-cyan);
            color: white;
        }

        .manual-quiz-button {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.3), rgba(255, 100, 0, 0.3));
            border: 2px solid #ff6600;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: bold;
            transition: all 0.2s ease;
            cursor: pointer;
            margin-top: 1rem;
        }

        .manual-quiz-button:hover {
            transform: translateY(-2px);
            border-color: #ff8800;
        }

        .manual-quiz-button.hidden {
            display: none;
        }

        .quiz-explanation {
            height: 100px;
            background: rgba(0, 20, 40, 0.5);
            border-radius: 10px;
            padding: 0.5rem;
            margin-top: 1rem;
            border: 1px solid rgba(0, 255, 255, 0.2);
            display: flex;
            align-items: flex-start;
            justify-content: center;
            text-align: center;
            overflow: hidden;
            box-sizing: border-box;
            font-size: 1rem;
            line-height: 1.4;
        }

        .quiz-explanation p {
            margin: 0;
            padding: 0;
            word-wrap: break-word;
            max-height: 100%;
            overflow: hidden;
            font-size: 1rem;
        }

        .quiz-explanation.has-content {
            border-color: var(--neon-green);
            background: rgba(0, 40, 20, 0.5);
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.2s ease;
            padding: 0.5rem;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .mode-btn:hover {
            border-color: var(--neon-cyan);
            transform: translateY(-1px);
            color: white;
        }

        .mode-btn.active {
            background: rgba(0, 255, 255, 0.2);
            border-color: var(--neon-cyan);
            color: var(--neon-cyan);
            transform: translateY(-1px);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .subject-modal-content {
            max-height: 90vh;
            overflow-y: auto;
            padding: 1.25rem;
            box-sizing: border-box;
            margin: auto;
        }

        .unit-modal-content {
            max-height: 75vh;
            overflow-y: auto;
            padding: 1rem 1.5rem 2rem 1.5rem;
            box-sizing: border-box;
            margin: auto;
        }

        .subject-grid {
            grid-template-columns: repeat(6, 1fr);
            gap: 0.4rem;
        }

        .category-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .container-spacing {
                max-width: 95%;
                margin-bottom: 2rem;
            }

            .neon-card {
                margin: 0.5rem;
                padding: 1rem;
            }

            .neon-card:last-of-type {
                margin-bottom: 4rem;
            }

            body {
                padding-bottom: 5rem;
            }

            .game-title {
                font-size: clamp(1.3rem, 7vw, 2rem);
            }

            .subject-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.3rem;
            }

            .category-grid {
                grid-template-columns: 1fr;
                gap: 0.3rem;
            }

            .subject-btn {
                padding: 0.3rem 0.15rem;
                min-height: 40px;
                font-size: 0.55rem;
            }

            .subject-btn .text-xl {
                font-size: 1rem !important;
            }

            .subject-btn .font-bold {
                font-size: 0.55rem !important;
            }

            .category-btn {
                padding: 0.4rem 0.2rem;
                min-height: 40px;
                font-size: 0.7rem;
            }

            .auto-quest-controls {
                gap: 0.5rem;
                flex-direction: column;
            }

            .time-selector {
                flex-wrap: wrap;
            }

            .time-option {
                padding: 0.2rem 0.6rem;
                font-size: 0.75rem;
            }

            .upgrade-button {
                padding: 0.5rem 0.75rem !important;
                font-size: 0.8rem;
            }

            .upgrade-button .upgrade-title {
                font-size: 0.9rem;
            }

            .upgrade-button .upgrade-cost {
                font-size: 0.7rem;
            }

            .quiz-explanation {
                min-height: 100px;
                padding: 0.9rem;
            }

            .quiz-option {
                padding: 0.5rem 0.75rem;
                font-size: 0.85rem;
                min-height: auto;
            }

            #quizQ {
                font-size: 0.9rem;
                line-height: 1.3;
            }

            .quiz-explanation {
                height: 80px;
                padding: 0.5rem;
                font-size: 0.75rem;
            }

            .quiz-explanation p {
                font-size: 0.9rem;
            }

            .modal {
                padding: 2rem 0.5rem;
            }

            .subject-modal-content {
                max-height: 92vh;
                padding: 1rem 0.75rem;
            }

            .unit-modal-content {
                max-height: 80vh;
                padding: 1rem 1rem 1.5rem 1rem;
            }

            .glow-text {
                font-size: 1.25rem !important;
            }
        }
    </style>
</head>

<body class="min-h-screen flex flex-col items-center pt-6 pb-12 gap-6 relative">
    <!-- 18È†ÖÁõÆÊïôÁßëÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ÔºàË§áÊï∞ÈÅ∏ÊäûÂØæÂøúÔºâ -->
    <div id="subjectModal" class="modal show">
        <div class="neon-card container-spacing subject-modal-content">
            <div class="text-center mb-4">
                <h1 class="game-title">JUKEN‚òÖQUEST</h1>
                <h2 class="text-xl font-black mb-3 glow-text">
                    üéØ ÊïôÁßëÈÅ∏Êäû
                </h2>
                <p class="text-gray-300 text-sm">Â≠¶Áøí„Åó„Åü„ÅÑÂàÜÈáé„ÇíÈÅ∏„Çì„Åß„ÇØ„Ç®„Çπ„Éà„ÇíÈñãÂßãÔºÅ</p>
            </div>
            <div id="subjectContainer" class="grid subject-grid mb-4">
            </div>
            <div class="text-center">
                <button id="startGame" class="neon-button px-6 py-2.5 text-base font-bold disabled:opacity-40 disabled:cursor-not-allowed">
                    üöÄ ÂçòÂÖÉÈÅ∏Êäû„Å∏ÈÄ≤„ÇÄ
                </button>
            </div>
        </div>
    </div>

    <!-- ÂçòÂÖÉÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
    <div id="unitSelectionModal" class="modal">
        <div class="neon-card container-spacing unit-modal-content">
            <div class="text-center mb-4">
                <h2 id="unitModalTitle" class="text-xl font-black mb-3 glow-text">
                    ÂçòÂÖÉÈÅ∏Êäû
                </h2>
                <p class="text-gray-300 text-sm">Â≠¶Áøí„Åô„ÇãÂçòÂÖÉ„ÇíÈÅ∏„Çì„Åß„Åè„Å†„Åï„ÅÑ</p>
            </div>
            <div id="unitContainer" class="grid category-grid mb-4"></div>
            <div class="text-center space-y-3">
                <button id="startSelectedQuiz" class="neon-button px-8 py-3 text-lg font-bold disabled:opacity-40 disabled:cursor-not-allowed" disabled>
                    üöÄ „ÇØ„Ç®„Çπ„ÉàÈñãÂßã
                </button>
                <br>
                <button id="backToSubjects" class="neon-button px-6 py-2 text-sm">
                    ‚Üê ÊïôÁßëÈÅ∏Êäû„Å´Êàª„Çã
                </button>
            </div>
        </div>
    </div>

    <!-- „É°„Ç§„É≥„Ç≤„Éº„É†ÁîªÈù¢ -->
    <div id="gameScreen" class="hidden">
        <div class="neon-card p-6 text-center container-spacing">
            <h1 class="game-title">
                JUKEN‚òÖQUEST
            </h1>
            <div id="currentSubject" class="mt-3 text-xl font-bold glow-text"></div>

            <!-- „Ç™„Éº„Éà„ÇØ„Ç®„Çπ„ÉàË®≠ÂÆö„Ç®„É™„Ç¢ -->
            <div class="auto-quest-controls">
                <button id="autoQuestToggle" class="toggle-button">
                    üöÄ „Ç™„Éº„Éà„ÇØ„Ç®„Çπ„Éà: OFF
                </button>
                <div class="time-selector">
                    <button class="time-option" data-time="60">1ÂàÜ</button>
                    <button class="time-option active" data-time="180">3ÂàÜ</button>
                    <button class="time-option" data-time="300">5ÂàÜ</button>
                    <button class="time-option" data-time="600">10ÂàÜ</button>
                    <button class="time-option" data-time="0">‚àû</button>
                </div>
            </div>

            <!-- ÊâãÂãï„ÇØ„Ç§„Ç∫„Éú„Çø„É≥ -->
            <button id="manualQuizButton" class="manual-quiz-button">
                üß† ÂïèÈ°å„Å´„ÉÅ„É£„É¨„É≥„Ç∏ÔºÅ
            </button>

            <!-- Âá∫È°å„É¢„Éº„ÉâÈÅ∏Êäû -->
            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 12px; border: 1px solid rgba(0, 255, 255, 0.2);">
                <div class="text-sm font-bold text-center mb-3 glow-text">üìã Âá∫È°å„É¢„Éº„Éâ</div>
                <div class="grid grid-cols-2 gap-2">
                    <button id="randomModeBtn" class="mode-btn active" data-mode="random">
                        üé≤ „É©„É≥„ÉÄ„É†
                    </button>
                    <button id="sequentialModeBtn" class="mode-btn" data-mode="sequential">
                        üìã È†ÜÁï™ÈÄö„Çä
                    </button>
                </div>
                <div class="text-xs text-gray-400 mt-2 text-center" id="modeDescription">
                    ÂïèÈ°å„Çí„É©„É≥„ÉÄ„É†„Å´Âá∫È°å„Åó„Åæ„Åô
                </div>
            </div>
        </div>

        <!-- „Ç≤„Éº„É†ÊÉÖÂ†± -->
        <div class="neon-card p-6 container-spacing">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†± -->
                <div class="space-y-4">
                    <h3 class="font-bold text-xl glow-text flex items-center gap-2">
                        üë§ „Éó„É¨„Ç§„É§„ÉºÊÉÖÂ†±
                    </h3>
                    <div id="stats" class="stats-grid text-sm"></div>
                </div>

                <!-- ÊïµÊÉÖÂ†± -->
                <div class="space-y-4">
                    <h3 class="font-bold text-xl glow-text flex items-center gap-2">
                        üéØ „Çø„Éº„Ç≤„ÉÉ„ÉàÊÉÖÂ†±
                    </h3>
                    <div id="enemyInfo" class="space-y-3">
                        <div id="enemyName" class="font-bold text-lg text-white"></div>
                        <div class="bg-gray-800 rounded-full h-6 p-1 border border-gray-600">
                            <div id="hpBar" class="hp-bar h-4 rounded-full"></div>
                        </div>
                        <div id="enemyStats" class="text-sm text-gray-300"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Âº∑Âåñ„É°„Éã„É•„Éº -->
        <div class="neon-card p-6 container-spacing">
            <h3 class="font-bold text-xl glow-text mb-6 flex items-center gap-2">
                ‚ö° „Éë„ÉØ„Éº„Ç¢„ÉÉ„Éó„Çª„É≥„Çø„Éº
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <button id="upgradeAttack" class="upgrade-button neon-button rounded-xl">
                    <div class="upgrade-title font-bold">‚öîÔ∏è ÊîªÊíÉÂäõÂº∑Âåñ</div>
                    <div class="upgrade-cost opacity-90">„Ç≥„Çπ„Éà: ¬•<span id="attackCost">100</span></div>
                </button>
                <button id="upgradeCrit" class="upgrade-button neon-button rounded-xl">
                    <div class="upgrade-title font-bold">üí• „ÇØ„É™„ÉÜ„Ç£„Ç´„É´Âº∑Âåñ</div>
                    <div class="upgrade-cost opacity-90">„Ç≥„Çπ„Éà: ¬•<span id="critCost">200</span></div>
                </button>
                <button id="upgradeDefense" class="upgrade-button neon-button rounded-xl">
                    <div class="upgrade-title font-bold">üõ°Ô∏è Èò≤Âæ°ÂäõÂº∑Âåñ</div>
                    <div class="upgrade-cost opacity-90">„Ç≥„Çπ„Éà: ¬•<span id="defenseCost">150</span></div>
                </button>
            </div>
        </div>
    </div>

    <!-- ÊïôÁßëÂ§âÊõ¥„Éú„Çø„É≥ -->
    <button id="changeSubject" class="floating-button hidden">
        üìö
    </button>

    <!-- „ÇØ„Ç§„Ç∫„É¢„Éº„ÉÄ„É´ -->
    <div id="quizModal" class="modal">
        <div class="neon-card p-4 w-full max-w-lg mx-4">
            <div class="text-center mb-4">
                <h2 class="font-black text-xl glow-text">
                    üß† „Éä„É¨„ÉÉ„Ç∏„Éê„Éà„É´ÔºÅ
                </h2>
            </div>
            <div class="space-y-4">
                <p id="quizQ" class="text-base font-medium text-center text-white leading-relaxed"></p>
                <div id="quizOptions" class="space-y-2"></div>
                <!-- Âõ∫ÂÆö„ÅÆËß£Ë™¨„Ç®„É™„Ç¢ -->
                <div id="quizExplanation" class="quiz-explanation">
                    <p id="quizMsg" class="font-bold text-center text-base"></p>
                </div>
                <div class="flex gap-2">
                    <button id="quizNext" class="flex-1 neon-button py-2 text-sm">
                        üî• Ê¨°„ÅÆÂïèÈ°å
                    </button>
                    <button id="quizBack" class="flex-1 neon-button py-2 text-sm">
                        üè† Êàª„Çã
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈÄöÁü• -->
    <div id="notification" class="notification">
        <div class="flex items-center gap-3">
            <span class="text-2xl">üéâ</span>
            <div>
                <div class="font-bold">„Ç∑„Çπ„ÉÜ„É†ÈÄöÁü•</div>
                <div id="notificationText" class="text-sm opacity-90"></div>
            </div>
        </div>
    </div>

    <script>
        /* ----------------- ÂäπÊûúÈü≥„Ç∑„Çπ„ÉÜ„É†ÔºàËªΩÈáèÁâàÔºâ ----------------- */
        class SoundSystem {
            constructor() {
                this.audioContext = null;
                this.initAudio();
            }

            initAudio() {
                try {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {}
            }

            playClick() {
                this.createTone(800, 0.1, 0.05, 'square');
            }

            playCorrect() {
                this.createTone(523, 0.1, 0.3);
                setTimeout(() => this.createTone(659, 0.1, 0.3), 100);
                setTimeout(() => this.createTone(784, 0.2, 0.3), 200);
            }

            playWrong() {
                this.createTone(200, 0.3, 0.3, 'sawtooth');
            }

            playCritical() {
                this.createTone(1000, 0.1, 0.4, 'square');
                setTimeout(() => this.createTone(1200, 0.1, 0.4, 'square'), 50);
                setTimeout(() => this.createTone(1500, 0.2, 0.4, 'square'), 100);
            }

            playCoin() {
                this.createTone(988, 0.1, 0.3);
                setTimeout(() => this.createTone(1319, 0.2, 0.3), 80);
            }

            playLevelUp() {
                const notes = [523, 587, 659, 698, 784, 880, 988, 1047];
                notes.forEach((freq, i) => {
                    setTimeout(() => this.createTone(freq, 0.1, 0.3), i * 60);
                });
            }

            createTone(frequency, duration, volume = 0.3, type = 'sine') {
                if (!this.audioContext) return;

                const oscillator = this.audioContext.createOscillator();
                const gainNode = this.audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(this.audioContext.destination);

                oscillator.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0, this.audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(volume, this.audioContext.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);

                oscillator.start(this.audioContext.currentTime);
                oscillator.stop(this.audioContext.currentTime + duration);
            }
        }

        const soundSystem = new SoundSystem();

        /* ----------------- „Ç´„ÉÜ„Ç¥„É™„ÉºÂÆöÁæ© ----------------- */
        const categories = {
            geography_1: [
                {id: 'geo_world_overview', name: '1.‰∏ñÁïå„ÅÆÂßø'},
                {id: 'geo_japan_overview', name: '2.Êó•Êú¨„ÅÆÂßø'},
                {id: 'geo_world_life', name: '3.‰∏ñÁïåÂêÑÂú∞„ÅÆ‰∫∫„ÄÖ„ÅÆÁîüÊ¥ª„Å®Áí∞Â¢É'},
                {id: 'geo_asia', name: '4.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄ„Ç¢„Ç∏„Ç¢Â∑û'},
                {id: 'geo_europe', name: '5.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄ„É®„Éº„É≠„ÉÉ„ÉëÂ∑û'},
                {id: 'geo_africa', name: '6.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄ„Ç¢„Éï„É™„Ç´Â∑û'}
            ],
            geography_2: [
                {id: 'geo_north_america', name: '7.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄÂåó„Ç¢„É°„É™„Ç´Â∑û'},
                {id: 'geo_south_america', name: '8.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄÂçó„Ç¢„É°„É™„Ç´Â∑û'},
                {id: 'geo_oceania', name: '9.‰∏ñÁïå„ÅÆË´∏Âú∞Âüü„ÄÄ„Ç™„Çª„Ç¢„Éã„Ç¢'},
                {id: 'geo_japan_features', name: '10.Êó•Êú¨„ÅÆÂú∞ÂüüÁöÑÁâπËâ≤'},
                {id: 'geo_japan_kyushu', name: '11.Êó•Êú¨„ÅÆË´∏Âú∞Âüü„ÄÄ‰πùÂ∑ûÂú∞Êñπ'},
                {id: 'geo_japan_chugoku', name: '12.Êó•Êú¨„ÅÆË´∏Âú∞Âüü„ÄÄ‰∏≠ÂõΩ„ÉªÂõõÂõΩÂú∞Êñπ'}
            ],
            history_1: [
                {id: 'hist_ancient', name: '1.ÊñáÊòé„ÅÆ„Åä„Åì„Çä„Å®Êó•Êú¨„ÅÆÊàê„ÇäÁ´ã„Å°'},
                {id: 'hist_ancient_state', name: '2.Âè§‰ª£ÂõΩÂÆ∂„ÅÆÊ≠©„Åø„Å®Êù±„Ç¢„Ç∏„Ç¢'},
                {id: 'hist_kamakura', name: '3.Ê≠¶Â£´„ÅÆ„Åä„Åì„Çä„Å®ÈéåÂÄâÂπïÂ∫ú'},
                {id: 'hist_muromachi', name: '4.„É¢„É≥„Ç¥„É´„ÅÆË•≤Êù•„Å®ÂÆ§Áî∫ÂπïÂ∫ú'}
            ],
            history_2: [
                {id: 'hist_unification', name: '5.„É®„Éº„É≠„ÉÉ„Éë‰∫∫„Å®„ÅÆÂá∫‰ºö„ÅÑ„Å®ÂÖ®ÂõΩÁµ±‰∏Ä'},
                {id: 'hist_edo_early', name: '6.Ê±üÊà∏ÂπïÂ∫ú„ÅÆÊàêÁ´ã„Å®ÈéñÂõΩ'},
                {id: 'hist_edo_develop', name: '7.Áî£Ê•≠„ÅÆÁô∫ÈÅî„Å®ÂπïÂ∫úÊîøÊ≤ª„ÅÆÂ±ïÈñã'},
                {id: 'hist_opening', name: '8.Ê¨ßÁ±≥„ÅÆÈÄ≤Âá∫„Å®Êó•Êú¨„ÅÆÈñãÂõΩ'},
                {id: 'hist_meiji', name: '9.ÊòéÊ≤ªÁ∂≠Êñ∞'}
            ],
            history_3: [
                {id: 'hist_wars', name: '10.Êó•Ê∏Ö„ÉªÊó•Èú≤Êà¶‰∫â„Å®Êó•Êú¨„ÅÆÁî£Ê•≠Èù©ÂëΩ'},
                {id: 'hist_wwi', name: '11.Á¨¨‰∏ÄÊ¨°‰∏ñÁïåÂ§ßÊà¶„Å®Êó•Êú¨'},
                {id: 'hist_wwii', name: '12.‰∏ñÁïåÊÅêÊÖå„Å®Á¨¨‰∫åÊ¨°‰∏ñÁïåÂ§ßÊà¶'},
                {id: 'hist_postwar', name: '13.Êà¶Âæå„ÅÆÊó•Êú¨„ÅÆÁô∫Â±ï„Å®ÂõΩÈöõÁ§æ‰ºö'}
            ],
            civics: [
                {id: 'civics_modern', name: '1.Áèæ‰ª£Á§æ‰ºö„Å®ÁßÅ„Åü„Å°'},
                {id: 'civics_constitution', name: '2.‰∫∫Èñì„ÅÆÂ∞äÈáç„Å®Êó•Êú¨ÂõΩÊÜ≤Ê≥ï'},
                {id: 'civics_democracy', name: '3.Áèæ‰ª£„ÅÆÊ∞ë‰∏ªÊîøÊ≤ª'},
                {id: 'civics_economy', name: '4.ÊöÆ„Çâ„Åó„Å®ÁµåÊ∏à'}
            ],
            chemistry_1: [
                {id: 'chemistry_basic', name: '1.Áâ©Ë≥™„Å®„Åù„ÅÆÊÄßË≥™'},
                {id: 'chemistry_gas', name: '2.Ê∞ó‰Ωì„ÅÆÊÄßË≥™'},
                {id: 'chemistry_solution', name: '3.Ê∞¥Ê∫∂Ê∂≤„ÅÆÊÄßË≥™'},
                {id: 'chemistry_state', name: '4.Áä∂ÊÖãÂ§âÂåñ'}
            ],
            chemistry_2: [
                {id: 'chemistry_change', name: '5.Áâ©Ë≥™„ÅÆÂ§âÂåñ'},
                {id: 'chemistry_structure', name: '6.Áâ©Ë≥™„ÅÆÊàê„ÇäÁ´ã„Å°'},
                {id: 'chemistry_reaction', name: '7.Áâ©Ë≥™„Å©„ÅÜ„Åó„ÅÆÂåñÂ≠¶Â§âÂåñ'},
                {id: 'chemistry_mass', name: '8.ÂåñÂ≠¶Â§âÂåñ„Å®Ë≥™Èáè'}
            ],
            chemistry_3: [
                {id: 'chemistry_ion', name: '9.„Ç§„Ç™„É≥„Å®ÈõªÊ±†'},
                {id: 'chemistry_acid', name: '10.ÈÖ∏„ÄÅ„Ç¢„É´„Ç´„É™„ÄÅÂ°©'}
            ],
            biology_1: [
                {id: 'biology_flower', name: '1.Ëä±„ÅÆ„Å§„Åè„Çä'},
                {id: 'biology_plant', name: '2.Ê†π„ÉªËëâ„ÅÆ„Å§„Åè„Çä„ÄÅÊ§çÁâ©„ÅÆÁâπÂæ¥„Å®ÂàÜÈ°û'},
                {id: 'biology_animal', name: '3.ÂãïÁâ©„ÅÆÁâπÂæ¥„Å®ÂàÜÈ°û'}
            ],
            biology_2: [
                {id: 'biology_microscope', name: '4.È°ïÂæÆÈè°„ÅÆ‰Ωø„ÅÑÊñπ'},
                {id: 'biology_cell', name: '5.ÁîüÁâ©„Å®Á¥∞ËÉû'},
                {id: 'biology_plant_body', name: '6.Ê§çÁâ©„ÅÆ„Åã„Çâ„Å†„ÅÆ„Å§„Åè„Çä„ÄÅÊ§çÁâ©„Å®Êó•ÂÖâ'},
                {id: 'biology_digestion', name: '7.Ê∂àÂåñ„Å®Âê∏Âèé'},
                {id: 'biology_breathing', name: '8.ÂëºÂê∏'},
                {id: 'biology_circulation', name: '9.Ë°ÄÊ∂≤„ÅÆÂæ™Áí∞„ÄÅÊéíÂá∫„ÅÆ„Åó„Åè„Åø'},
                {id: 'biology_response', name: '10.Âà∫ÊøÄ„Å®ÂèçÂøú„ÄÅÂãïÁâ©„ÅÆ„Åã„Çâ„Å†'}
            ],
            biology_3: [
                {id: 'biology_growth', name: '11.ÁîüÁâ©„ÅÆÊàêÈï∑„Å®Á¥∞ËÉû„ÅÆÂ§âÂåñ'},
                {id: 'biology_reproduction', name: '12.ÁîüÁâ©„ÅÆÁîüÊÆñ'},
                {id: 'biology_heredity', name: '13.ÈÅ∫‰ºù„ÅÆË¶èÂâáÊÄß„Å®ÈÅ∫‰ºùÂ≠ê'},
                {id: 'biology_evolution', name: '14.ÁîüÁâ©„ÅÆÈÄ≤Âåñ„ÄÅÁîüÊÖãÁ≥ª„Å®È£üÁâ©ÈÄ£Èéñ'},
                {id: 'biology_environment', name: '15.Ëá™ÁÑ∂„Å®Áí∞Â¢É„ÄÅ‰∫∫Èñì„Å®Ëá™ÁÑ∂Áí∞Â¢É'}
            ],
            physics_1: [
                {id: 'physics_light', name: '1.ÂÖâ„Å´„Çà„ÇãÁèæË±°'},
                {id: 'physics_sound', name: '2.Èü≥„Å´„Çà„ÇãÁèæË±°'},
                {id: 'physics_force', name: '3.Âäõ„Å´„Çà„ÇãÁèæË±°'}
            ],
            physics_2: [
                {id: 'physics_current', name: '4.ÈõªÊµÅ„Å®ÈõªÂúß'},
                {id: 'physics_energy', name: '5.ÈõªÊ∞ó„Ç®„Éç„É´„ÇÆ„Éº'},
                {id: 'physics_magnetic', name: '6.ÈõªÊµÅ„Å®Á£ÅÁïå'}
            ],
            physics_3: [
                {id: 'physics_balance', name: '7.Âäõ„ÅÆ„Å§„ÇäÂêà„ÅÑ„Å®ÂêàÊàê„ÉªÂàÜËß£'},
                {id: 'physics_motion', name: '8.Áâ©‰Ωì„ÅÆÈÅãÂãï'},
                {id: 'physics_pressure', name: '9.Ê∞¥Âúß„Å®ÊµÆÂäõ'},
                {id: 'physics_work', name: '10.„Ç®„Éç„É´„ÇÆ„Éº„Å®‰ªï‰∫ã'},
                {id: 'physics_energy_change', name: '11.„Ç®„Éç„É´„ÇÆ„Éº„ÅÆÁßª„ÇäÂ§â„Çè„Çä'},
                {id: 'physics_resources', name: '12.„Ç®„Éç„É´„ÇÆ„ÉºË≥áÊ∫ê„ÅÆÂà©Áî®'}
            ],
            earth_1: [
                {id: 'earth_volcano', name: '1.ÁÅ´Â±±'},
                {id: 'earth_earthquake', name: '2.Âú∞Èúá'},
                {id: 'earth_strata', name: '3.Âú∞Â±§„ÅÆ„Åß„ÅçÊñπ'}
            ],
            earth_2: [
                {id: 'earth_weather', name: '4.Ê∞óË±°„ÅÆË¶≥Ê∏¨„ÄÅÂ§ßÊ∞óÂúß„Å®ÂúßÂäõ'},
                {id: 'earth_front', name: '5.Ê∞óÂõ£„Å®ÂâçÁ∑ö„ÄÅÊó•Êú¨„ÅÆÂ§©Ê∞ó'},
                {id: 'earth_cloud', name: '6.Èõ≤„ÅÆ„Åß„ÅçÊñπ„Å®Ê∞¥Ëí∏Ê∞ó'}
            ],
            earth_3: [
                {id: 'earth_celestial', name: '7.Âú∞ÁêÉ„ÅÆÂãï„Åç„Å®Â§©‰Ωì„ÅÆÂãï„Åç'},
                {id: 'earth_solar', name: '8.Â§™ÈôΩÁ≥ª„ÅÆÂ§©‰Ωì'},
                {id: 'earth_moon', name: '9.Êúà„Å®ÊÉëÊòü„ÅÆË¶ã„ÅàÊñπ„ÄÅËá™ÁÑ∂„ÅÆÊÅµ„Åø„Å®ÁÅΩÂÆ≥'}
            ]
        };

        /* ----------------- „Ç≤„Éº„É†Â§âÊï∞ ----------------- */
        let coins = 0;
        let dps = 10;
        let critRate = 5;
        let defense = 0;
        let enemyHPMax = 100;
        let enemyHP = enemyHPMax;
        let killCount = 0;
        let currentSubject = '';
        let attackCost = 100;
        let critCost = 200;
        let defenseCost = 150;

        // „Ç™„Éº„Éà„ÇØ„Ç®„Çπ„ÉàË®≠ÂÆö
        let autoQuestEnabled = false;
        let autoQuestInterval = 180;
        let autoQuestTimer = null;
        let autoQuestCountdown = 0;

        // ÂçòÂÖÉÈÅ∏Êäû„Å®Âá∫È°å„É¢„Éº„ÉâÈñ¢ÈÄ£Â§âÊï∞
        let selectedSubjects = []; // Ë§áÊï∞ÊïôÁßëÈÅ∏ÊäûÁî®
        let selectedCategories = [];
        let questionMode = 'random';
        let sequentialIndex = 0;
        let usedQuestions = [];
        let particleOffset = 0;

        // ÂÆüÁ∏æ„ÉªÁµ±Ë®àÈñ¢ÈÄ£
        let achievements = {};
        let totalQuestionsAnswered = 0;
        let totalCorrectAnswers = 0;
        let playTime = 0;

        /* ----------------- DOMË¶ÅÁ¥† ----------------- */
        const enemyName = document.getElementById('enemyName');
        const hpBar = document.getElementById('hpBar');
        const statsDiv = document.getElementById('stats');
        const currentSubjectDiv = document.getElementById('currentSubject');
        const manualQuizButton = document.getElementById('manualQuizButton');

        /* ----------------- „Ç®„Éï„Çß„ÇØ„ÉàÈñ¢Êï∞ÔºàËªΩÈáèÁâàÔºâ ----------------- */
        function createParticle(text, color, x, y) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = text;
            particle.style.color = color;
            particle.style.left = (x + particleOffset) + 'px';
            particle.style.top = (y + particleOffset) + 'px';
            particle.style.fontSize = '18px';
            document.body.appendChild(particle);

            particleOffset += 30;
            if (particleOffset > 120) particleOffset = 0;

            setTimeout(() => {
                if (particle.parentNode) {
                    particle.parentNode.removeChild(particle);
                }
            }, 2000);
        }

        function showNotification(text) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = text;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        /* ----------------- Ë§áÊï∞ÊïôÁßëÈÅ∏ÊäûÂØæÂøú„ÅÆ18È†ÖÁõÆÈÅ∏Êäû ----------------- */
        function initSubjectSelection() {
            const container = document.getElementById('subjectContainer');
            const startButton = document.getElementById('startGame');

            const subjectNameMap = {
                'geography_1': 'üó∫Ô∏è ‰∏≠ÔºëÂú∞ÁêÜ',
                'geography_2': 'üóæ ‰∏≠ÔºíÂú∞ÁêÜ',
                'history_1': '‚õ©Ô∏è ‰∏≠ÔºëÊ≠¥Âè≤',
                'history_2': 'üèØ ‰∏≠ÔºíÊ≠¥Âè≤',
                'history_3': 'üè≠ ‰∏≠ÔºìÊ≠¥Âè≤',
                'civics': '‚öñÔ∏è ÂÖ¨Ê∞ë',
                'chemistry_1': 'üß™ ‰∏≠ÔºëÂåñÂ≠¶',
                'chemistry_2': '‚öõÔ∏è ‰∏≠ÔºíÂåñÂ≠¶',
                'chemistry_3': '‚ö° ‰∏≠ÔºìÂåñÂ≠¶',
                'biology_1': 'üå± ‰∏≠ÔºëÁîüÁâ©',
                'biology_2': 'üêæ ‰∏≠ÔºíÁîüÁâ©',
                'biology_3': 'üß¨ ‰∏≠ÔºìÁîüÁâ©',
                'physics_1': 'üí° ‰∏≠ÔºëÁâ©ÁêÜ',
                'physics_2': '‚ö° ‰∏≠ÔºíÁâ©ÁêÜ',
                'physics_3': 'üöÄ ‰∏≠ÔºìÁâ©ÁêÜ',
                'earth_1': 'üèîÔ∏è ‰∏≠ÔºëÂú∞Â≠¶',
                'earth_2': 'üå§Ô∏è ‰∏≠ÔºíÂú∞Â≠¶',
                'earth_3': 'üåå ‰∏≠ÔºìÂú∞Â≠¶'
            };

            const subjects = [
                {id: 'geography_1', icon: 'üó∫Ô∏è', name: '‰∏≠ÔºëÂú∞ÁêÜ'},
                {id: 'geography_2', icon: 'üóæ', name: '‰∏≠ÔºíÂú∞ÁêÜ'},
                {id: 'history_1', icon: '‚õ©Ô∏è', name: '‰∏≠ÔºëÊ≠¥Âè≤'},
                {id: 'history_2', icon: 'üèØ', name: '‰∏≠ÔºíÊ≠¥Âè≤'},
                {id: 'history_3', icon: 'üè≠', name: '‰∏≠ÔºìÊ≠¥Âè≤'},
                {id: 'civics', icon: '‚öñÔ∏è', name: 'ÂÖ¨Ê∞ë'},
                {id: 'chemistry_1', icon: 'üß™', name: '‰∏≠ÔºëÂåñÂ≠¶'},
                {id: 'chemistry_2', icon: '‚öõÔ∏è', name: '‰∏≠ÔºíÂåñÂ≠¶'},
                {id: 'chemistry_3', icon: '‚ö°', name: '‰∏≠ÔºìÂåñÂ≠¶'},
                {id: 'biology_1', icon: 'üå±', name: '‰∏≠ÔºëÁîüÁâ©'},
                {id: 'biology_2', icon: 'üêæ', name: '‰∏≠ÔºíÁîüÁâ©'},
                {id: 'biology_3', icon: 'üß¨', name: '‰∏≠ÔºìÁîüÁâ©'},
                {id: 'physics_1', icon: 'üí°', name: '‰∏≠ÔºëÁâ©ÁêÜ'},
                {id: 'physics_2', icon: '‚ö°', name: '‰∏≠ÔºíÁâ©ÁêÜ'},
                {id: 'physics_3', icon: 'üöÄ ‰∏≠ÔºìÁâ©ÁêÜ'},
                {id: 'earth_1', icon: 'üèîÔ∏è', name: '‰∏≠ÔºëÂú∞Â≠¶'},
                {id: 'earth_2', icon: 'üå§Ô∏è', name: '‰∏≠ÔºíÂú∞Â≠¶'},
                {id: 'earth_3', icon: 'üåå', name: '‰∏≠ÔºìÂú∞Â≠¶'}
            ];

            if (!container) return;

            container.innerHTML = "";
            const fragment = document.createDocumentFragment();

            subjects.forEach(subject => {
                const btn = document.createElement('button');
                btn.className = 'subject-btn';
                btn.innerHTML = `<div class="text-xl mb-1">${subject.icon}</div><div class="font-bold text-xs">${subject.name}</div>`;
                btn.onclick = () => {
                    soundSystem.playClick();
                    if (selectedSubjects.includes(subject.id)) {
                        // ÈÅ∏ÊäûËß£Èô§
                        selectedSubjects = selectedSubjects.filter(id => id !== subject.id);
                        btn.classList.remove('active');
                    } else {
                        // ÈÅ∏ÊäûËøΩÂä†
                        selectedSubjects.push(subject.id);
                        btn.classList.add('active');
                    }
                    updateSubjectSelectionUI();
                };
                fragment.appendChild(btn);
            });

            container.appendChild(fragment);

            function updateSubjectSelectionUI() {
                startButton.disabled = selectedSubjects.length === 0;
            }

            startButton.onclick = () => {
                if (selectedSubjects.length > 0) {
                    soundSystem.playLevelUp();
                    openUnitSelection();
                }
            };

            updateSubjectSelectionUI();
        }

        /* ----------------- ÂçòÂÖÉÈÅ∏ÊäûÊ©üËÉΩÔºàË§áÊï∞ÊïôÁßëÂØæÂøúÔºâ ----------------- */
        function openUnitSelection() {
            document.getElementById('subjectModal').classList.remove('show');

            const subjectNames = {
                'geography_1': 'üó∫Ô∏è ‰∏≠ÔºëÂú∞ÁêÜ',
                'geography_2': 'üóæ ‰∏≠ÔºíÂú∞ÁêÜ',
                'history_1': '‚õ©Ô∏è ‰∏≠ÔºëÊ≠¥Âè≤',
                'history_2': 'üèØ ‰∏≠ÔºíÊ≠¥Âè≤',
                'history_3': 'üè≠ ‰∏≠ÔºìÊ≠¥Âè≤',
                'civics': '‚öñÔ∏è ÂÖ¨Ê∞ë',
                'chemistry_1': 'üß™ ‰∏≠ÔºëÂåñÂ≠¶',
                'chemistry_2': '‚öõÔ∏è ‰∏≠ÔºíÂåñÂ≠¶',
                'chemistry_3': '‚ö° ‰∏≠ÔºìÂåñÂ≠¶',
                'biology_1': 'üå± ‰∏≠ÔºëÁîüÁâ©',
                'biology_2': 'üêæ ‰∏≠ÔºíÁîüÁâ©',
                'biology_3': 'üß¨ ‰∏≠ÔºìÁîüÁâ©',
                'physics_1': 'üí° ‰∏≠ÔºëÁâ©ÁêÜ',
                'physics_2': '‚ö° ‰∏≠ÔºíÁâ©ÁêÜ',
                'physics_3': 'üöÄ ‰∏≠ÔºìÁâ©ÁêÜ',
                'earth_1': 'üèîÔ∏è ‰∏≠ÔºëÂú∞Â≠¶',
                'earth_2': 'üå§Ô∏è ‰∏≠ÔºíÂú∞Â≠¶',
                'earth_3': 'üåå ‰∏≠ÔºìÂú∞Â≠¶'
            };

            const selectedNames = selectedSubjects.map(id => subjectNames[id]).join('„Éª');
            document.getElementById('unitModalTitle').textContent = `${selectedNames} - ÂçòÂÖÉÈÅ∏Êäû`;

            const unitContainer = document.getElementById('unitContainer');
            unitContainer.innerHTML = '';
            selectedCategories = [];

            // ÈÅ∏Êäû„Åï„Çå„ÅüÂÖ®ÊïôÁßë„ÅÆÂçòÂÖÉ„ÇíË°®Á§∫
            selectedSubjects.forEach(subjectId => {
                if (categories[subjectId]) {
                    // ÊïôÁßëÂêç„É©„Éô„É´„ÇíËøΩÂä†
                    const subjectLabel = document.createElement('div');
                    subjectLabel.className = 'grade-label';
                    subjectLabel.textContent = subjectNames[subjectId];
                    unitContainer.appendChild(subjectLabel);

                    // „Åù„ÅÆÊïôÁßë„ÅÆÂçòÂÖÉ„Éú„Çø„É≥„ÇíËøΩÂä†
                    categories[subjectId].forEach(unit => {
                        const btn = document.createElement('button');
                        btn.className = 'category-btn';
                        btn.textContent = unit.name;
                        btn.onclick = () => toggleUnitSelection(unit.id, btn);
                        unitContainer.appendChild(btn);
                    });
                }
            });

            document.getElementById('unitSelectionModal').classList.add('show');
            updateStartButton();
        }

        function toggleUnitSelection(unitId, buttonElement) {
            soundSystem.playClick();
            if (selectedCategories.includes(unitId)) {
                selectedCategories = selectedCategories.filter(id => id !== unitId);
                buttonElement.classList.remove('active');
            } else {
                selectedCategories.push(unitId);
                buttonElement.classList.add('active');
            }
            updateStartButton();
        }

        function updateStartButton() {
            const startButton = document.getElementById('startSelectedQuiz');
            startButton.disabled = selectedCategories.length === 0;
        }

        /* ----------------- Âá∫È°å„É¢„Éº„ÉâÈñ¢ÈÄ£ ----------------- */
        function setQuestionMode(mode) {
            questionMode = mode;
            document.getElementById('randomModeBtn').classList.remove('active');
            document.getElementById('sequentialModeBtn').classList.remove('active');

            if (mode === 'random') {
                document.getElementById('randomModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'ÂïèÈ°å„Çí„É©„É≥„ÉÄ„É†„Å´Âá∫È°å„Åó„Åæ„Åô';
                usedQuestions = [];
                showNotification('üé≤ „É©„É≥„ÉÄ„É†Âá∫È°å„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü');
            } else {
                document.getElementById('sequentialModeBtn').classList.add('active');
                document.getElementById('modeDescription').textContent = 'ÂïèÈ°å„ÇíÈ†ÜÁï™ÈÄö„Çä„Å´Âá∫È°å„Åó„Åæ„Åô';
                sequentialIndex = 0;
                showNotification('üìã È†ÜÁï™ÈÄö„ÇäÂá∫È°å„Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü');
            }
        }

        /* ----------------- „Ç™„Éº„Éà„ÇØ„Ç®„Çπ„ÉàÈñ¢ÈÄ£ ----------------- */
        function initAutoQuestControls() {
            const toggleButton = document.getElementById('autoQuestToggle');
            const timeOptions = document.querySelectorAll('.time-option');

            toggleButton.onclick = () => {
                soundSystem.playClick();
                autoQuestEnabled = !autoQuestEnabled;
                updateAutoQuestUI();

                if (autoQuestEnabled) {
                    startAutoQuest();
                    showNotification('üöÄ „Ç™„Éº„Éà„ÇØ„Ç®„Çπ„ÉàÈñãÂßãÔºÅ');
                } else {
                    stopAutoQuest();
                    showNotification('‚è∏Ô∏è „Ç™„Éº„Éà„ÇØ„Ç®„Çπ„ÉàÂÅúÊ≠¢');
                }
            };

            timeOptions.forEach(option => {
                option.onclick = () => {
                    soundSystem.playClick();
                    timeOptions.forEach(opt => opt.classList.remove('active'));
                    option.classList.add('active');
                    autoQuestInterval = parseInt(option.dataset.time);

                    if (autoQuestEnabled) {
                        stopAutoQuest();
                        startAutoQuest();
                    }

                    const timeText = option.textContent;
                    showNotification(`‚è∞ ÈñìÈöî„Çí${timeText}„Å´Ë®≠ÂÆö`);
                };
            });

            manualQuizButton.onclick = () => {
                soundSystem.playClick();
                openQuiz();
            };
        }

        function updateAutoQuestUI() {
            const toggleButton = document.getElementById('autoQuestToggle');

            if (autoQuestEnabled) {
                toggleButton.textContent = 'üöÄ „Ç™„Éº„Éà„ÇØ„Ç®„Çπ„Éà: ON';
                toggleButton.classList.add('active');
                manualQuizButton.classList.add('hidden');
            } else {
                toggleButton.textContent = 'üöÄ „Ç™„Éº„Éà„ÇØ„Ç®„Çπ„Éà: OFF';
                toggleButton.classList.remove('active');
                manualQuizButton.classList.remove('hidden');
            }
        }

        function startAutoQuest() {
            if (autoQuestInterval === 0) {
                openQuiz();
                return;
            }

            openQuiz();
            autoQuestCountdown = autoQuestInterval;
            autoQuestTimer = setInterval(() => {
                autoQuestCountdown--;
                if (autoQuestCountdown <= 0) {
                    if (!document.getElementById('quizModal').classList.contains('show')) {
                        openQuiz();
                    }
                    autoQuestCountdown = autoQuestInterval;
                }
            }, 1000);
        }

        function stopAutoQuest() {
            if (autoQuestTimer) {
                clearInterval(autoQuestTimer);
                autoQuestTimer = null;
            }
            autoQuestCountdown = 0;
        }

        /* ----------------- ÁîªÈù¢Êõ¥Êñ∞ ----------------- */
        function renderStats() {
            const autoQuestStatus = autoQuestEnabled && autoQuestInterval > 0 
                ? `(Ê¨°Âõû: ${autoQuestCountdown}ÁßíÂæå)` 
                : autoQuestEnabled && autoQuestInterval === 0 
                ? '(ÁÑ°Âà∂Èôê„É¢„Éº„Éâ)' : '';

            const achievementCount = Object.keys(achievements).length;

            statsDiv.innerHTML = `
                <div class="stat-item">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300">üí∞ „Ç≥„Ç§„É≥</span>
                        <span class="font-bold text-yellow-400">${coins.toLocaleString()}</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300">‚öîÔ∏è ÊîªÊíÉÂäõ</span>
                        <span class="font-bold text-red-400">${dps}/Áßí</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300">üí• „ÇØ„É™„ÉÜ„Ç£„Ç´„É´Áéá</span>
                        <span class="font-bold text-yellow-400">${critRate}%</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300">üõ°Ô∏è Èò≤Âæ°Âäõ</span>
                        <span class="font-bold text-blue-400">${defense}</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300">üèÜ ÊíÉÁ†¥Êï∞</span>
                        <span class="font-bold text-purple-400">${killCount}</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300">üìö Á∑èÂïèÈ°åÊï∞</span>
                        <span class="font-bold text-green-400">${totalQuestionsAnswered}</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300">‚úÖ Ê≠£Ëß£Áéá</span>
                        <span class="font-bold text-cyan-400">${getAccuracyRate()}%</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300">üèÖ ÂÆüÁ∏æ</span>
                        <span class="font-bold text-gold-400">${achievementCount}/8</span>
                    </div>
                </div>
                <div class="stat-item">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-300">‚è∞ „Éó„É¨„Ç§ÊôÇÈñì</span>
                        <span class="font-bold text-pink-400">${formatPlayTime(playTime)}</span>
                    </div>
                </div>
                ${autoQuestEnabled ? `
                <div class="stat-item border-cyan-400">
                    <div class="text-center">
                        <span class="font-medium text-cyan-300">üöÄ „Ç™„Éº„Éà„ÇØ„Ç®„Çπ„Éà</span>
                        <div class="text-xs text-cyan-400 mt-1">${autoQuestStatus}</div>
                    </div>
                </div>
                ` : ''}
            `;

            document.getElementById('attackCost').textContent = attackCost;
            document.getElementById('critCost').textContent = critCost;
            document.getElementById('defenseCost').textContent = defenseCost;

            document.getElementById('upgradeAttack').disabled = coins < attackCost;
            document.getElementById('upgradeCrit').disabled = coins < critCost;
            document.getElementById('upgradeDefense').disabled = coins < defenseCost;
        }

        function renderEnemy() {
            const subjectNames = {
                'geography_1': 'üó∫Ô∏è ‰∏≠ÔºëÂú∞ÁêÜ„É¢„É≥„Çπ„Çø„Éº',
                'geography_2': 'üóæ ‰∏≠ÔºíÂú∞ÁêÜ„É¢„É≥„Çπ„Çø„Éº',
                'history_1': '‚õ©Ô∏è ‰∏≠ÔºëÊ≠¥Âè≤„É¢„É≥„Çπ„Çø„Éº',
                'history_2': 'üèØ ‰∏≠ÔºíÊ≠¥Âè≤„É¢„É≥„Çπ„Çø„Éº',
                'history_3': 'üè≠ ‰∏≠ÔºìÊ≠¥Âè≤„É¢„É≥„Çπ„Çø„Éº',
                'civics': '‚öñÔ∏è ÂÖ¨Ê∞ë„É¢„É≥„Çπ„Çø„Éº',
                'chemistry_1': 'üß™ ‰∏≠ÔºëÂåñÂ≠¶„É¢„É≥„Çπ„Çø„Éº',
                'chemistry_2': '‚öõÔ∏è ‰∏≠ÔºíÂåñÂ≠¶„É¢„É≥„Çπ„Çø„Éº',
                'chemistry_3': '‚ö° ‰∏≠ÔºìÂåñÂ≠¶„É¢„É≥„Çπ„Çø„Éº',
                'biology_1': 'üå± ‰∏≠ÔºëÁîüÁâ©„É¢„É≥„Çπ„Çø„Éº',
                'biology_2': 'üêæ ‰∏≠ÔºíÁîüÁâ©„É¢„É≥„Çπ„Çø„Éº',
                'biology_3': 'üß¨ ‰∏≠ÔºìÁîüÁâ©„É¢„É≥„Çπ„Çø„Éº',
                'physics_1': 'üí° ‰∏≠ÔºëÁâ©ÁêÜ„É¢„É≥„Çπ„Çø„Éº',
                'physics_2': '‚ö° ‰∏≠ÔºíÁâ©ÁêÜ„É¢„É≥„Çπ„Çø„Éº',
                'physics_3': 'üöÄ ‰∏≠ÔºìÁâ©ÁêÜ„É¢„É≥„Çπ„Çø„Éº',
                'earth_1': 'üèîÔ∏è ‰∏≠ÔºëÂú∞Â≠¶„É¢„É≥„Çπ„Çø„Éº',
                'earth_2': 'üå§Ô∏è ‰∏≠ÔºíÂú∞Â≠¶„É¢„É≥„Çπ„Çø„Éº',
                'earth_3': 'üåå ‰∏≠ÔºìÂú∞Â≠¶„É¢„É≥„Çπ„Çø„Éº'
            };

            const currentEnemyType = selectedSubjects.length > 0 ? 'üåü Ë§áÂêà„É¢„É≥„Çπ„Çø„Éº' : '„ÉÜ„Çπ„Éà„É¢„É≥„Çπ„Çø„Éº';
            enemyName.textContent = `${currentEnemyType} Lv.${Math.floor(killCount / 5) + 1}`;

            const hpPercent = (enemyHP / enemyHPMax) * 100;
            hpBar.style.width = hpPercent + '%';

            document.getElementById('enemyStats').textContent = `HP: ${enemyHP}/${enemyHPMax}`;
        }

        /* ----------------- „Éê„Éà„É´„É´„Éº„Éó ----------------- */
        function startBattleLoop() {
            setInterval(() => {
                const isCrit = Math.random() * 100 < critRate;
                const damage = isCrit ? dps * 2 : dps;
                enemyHP -= damage;

                const enemyElement = document.getElementById('enemyInfo');
                const rect = enemyElement.getBoundingClientRect();
                const offsetX = (Math.random() - 0.5) * 100;
                const offsetY = (Math.random() - 0.5) * 50;

                createParticle(
                    isCrit ? `üí• CRIT! -${damage}` : `‚öîÔ∏è -${damage}`,
                    isCrit ? '#ffff00' : '#ff4444',
                    rect.left + rect.width / 2 + offsetX,
                    rect.top + offsetY
                );

                if (isCrit) {
                    soundSystem.playCritical();
                }

                if (enemyHP <= 0) {
                    const coinReward = 50 + Math.floor(killCount / 10) * 25;
                    coins += coinReward;
                    killCount++;
                    enemyHPMax = Math.round(enemyHPMax * 1.15);
                    enemyHP = enemyHPMax;

                    soundSystem.playCoin();
                    createParticle(
                        `üí∞ +${coinReward}`,
                        '#00ffff',
                        window.innerWidth / 2 + (Math.random() - 0.5) * 100,
                        window.innerHeight / 2
                    );

                    if (killCount % 50 === 0) {
                        enemyHPMax *= 2;
                        enemyHP = enemyHPMax;
                        showNotification('üî• „Éú„ÇπÁ¥ö„É¢„É≥„Çπ„Çø„ÉºÂá∫ÁèæÔºÅ');
                    }
                }

                renderStats();
                renderEnemy();
            }, 1000);
        }

        /* ----------------- Âº∑Âåñ„Éú„Çø„É≥ ----------------- */
        function initUpgradeButtons() {
            document.getElementById('upgradeAttack').onclick = () => {
                if (coins >= attackCost) {
                    soundSystem.playLevelUp();
                    coins -= attackCost;
                    dps += 10;
                    attackCost = Math.floor(attackCost * 1.5);
                    createParticle('‚öîÔ∏è ÊîªÊíÉÂäõUP!', '#ff4444', window.innerWidth / 2, window.innerHeight / 3);
                    showNotification('ÊîªÊíÉÂäõ„ÅåÂº∑Âåñ„Åï„Çå„Åæ„Åó„ÅüÔºÅ');
                    renderStats();
                }
            };

            document.getElementById('upgradeCrit').onclick = () => {
                if (coins >= critCost) {
                    soundSystem.playLevelUp();
                    coins -= critCost;
                    critRate += 5;
                    critCost = Math.floor(critCost * 1.8);
                    createParticle('üí• „ÇØ„É™„ÉÜ„Ç£„Ç´„É´UP!', '#ffff00', window.innerWidth / 2, window.innerHeight / 3);
                    showNotification('„ÇØ„É™„ÉÜ„Ç£„Ç´„É´Áéá„ÅåÂêë‰∏ä„Åó„Åæ„Åó„ÅüÔºÅ');
                    renderStats();
                }
            };

            document.getElementById('upgradeDefense').onclick = () => {
                if (coins >= defenseCost) {
                    soundSystem.playLevelUp();
                    coins -= defenseCost;
                    defense += 10;
                    defenseCost = Math.floor(defenseCost * 1.6);
                    createParticle('üõ°Ô∏è Èò≤Âæ°ÂäõUP!', '#00ffff', window.innerWidth / 2, window.innerHeight / 3);
                    showNotification('Èò≤Âæ°Âäõ„ÅåÂêë‰∏ä„Åó„Åæ„Åó„ÅüÔºÅ');
                    renderStats();
                }
            };
        }

        /* ----------------- „ÇØ„Ç§„Ç∫Ê©üËÉΩÔºà‰øÆÊ≠£ÁâàÔºâ ----------------- */
        function openQuiz() {
            if (selectedCategories.length === 0) {
                showNotification('ÂçòÂÖÉ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }

            let allProblems = [];
            selectedCategories.forEach(categoryId => {
                // problemDatabase„ÇíÊ≠£„Åó„ÅèÂèÇÁÖß
                if (typeof window.problemDatabase !== 'undefined' && window.problemDatabase && window.problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(window.problemDatabase[categoryId]);
                } else if (typeof problemDatabase !== 'undefined' && problemDatabase && problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(problemDatabase[categoryId]);
                } else {
                    console.warn(`ÂïèÈ°å„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${categoryId}`);
                }
            });

            if (allProblems.length === 0) {
                showNotification('ÈÅ∏Êäû„Åï„Çå„ÅüÂçòÂÖÉ„ÅÆÂïèÈ°å„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                return;
            }

            let quiz;
            let remainingCount;

            if (questionMode === 'random') {
                if (usedQuestions.length >= allProblems.length) {
                    usedQuestions = [];
                    showNotification('üéâ ÂÖ®Âïè„ÇØ„É™„Ç¢ÔºÅÂïèÈ°å„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
                }

                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;

                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('üîÑ ÂÖ®ÂïèÈ°å„Çí‰∏ÄÂë®„Åó„Åæ„Åó„ÅüÔºÅÊúÄÂàù„Åã„ÇâÂÜçÈñã„Åó„Åæ„Åô');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            const modal = document.getElementById('quizModal');
            const qEl = document.getElementById('quizQ');
            const optDiv = document.getElementById('quizOptions');
            const msgEl = document.getElementById('quizMsg');
            const explanationEl = document.getElementById('quizExplanation');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            qEl.textContent = `${quiz.q} (ÊÆã„Çä${remainingCount}Âïè)`;
            optDiv.innerHTML = '';
            msgEl.textContent = '';
            explanationEl.classList.remove('has-content');

            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            backBtn.disabled = true;
            backBtn.style.opacity = '0.3';

            let firstAnswer = false;

            quiz.opts.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.textContent = txt;
                btn.className = 'quiz-option w-full';
                btn.onclick = () => {
                    if (!firstAnswer) {
                        firstAnswer = true;
                        totalQuestionsAnswered++;

                        if (i === quiz.ans) {
                            totalCorrectAnswers++;
                            soundSystem.playCorrect();
                            coins += 100;
                            createParticle('üí∞ +100', '#00ffff', window.innerWidth / 2, window.innerHeight / 2);
                            showNotification('Ê≠£Ëß£ÔºÅ„Ç≥„Ç§„É≥Áç≤ÂæóÔºÅ');
                        } else {
                            soundSystem.playWrong();
                        }

                        renderStats();
                        checkAchievements();

                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                        backBtn.disabled = false;
                        backBtn.style.opacity = '1';
                    }

                    if (i === quiz.ans) {
                        msgEl.innerHTML = `üéâ Ê≠£Ëß£ÔºÅ${quiz.exp || ''}`;
                        msgEl.style.color = '#00ff41';
                    } else {
                        msgEl.innerHTML = `‚ùå ‰∏çÊ≠£Ëß£„ÄÇÊ≠£Ëß£„ÅØ„Äå${quiz.opts[quiz.ans]}„Äç„Åß„Åô„ÄÇ${quiz.exp || ''}`;
                        msgEl.style.color = '#ff8800';
                    }
                    explanationEl.classList.add('has-content');

                    if (autoQuestEnabled && autoQuestInterval === 0) {
                        setTimeout(() => {
                            loadNextQuiz();
                        }, 1500);
                    }
                };
                optDiv.appendChild(btn);
            });

            nextBtn.onclick = () => {
                soundSystem.playClick();
                loadNextQuiz();
            };

            backBtn.onclick = () => {
                soundSystem.playClick();
                if (autoQuestEnabled) {
                    autoQuestEnabled = false;
                    stopAutoQuest();
                    updateAutoQuestUI();
                }
                modal.classList.remove('show');
                showNotification('üè† „É°„Ç§„É≥ÁîªÈù¢„Å´Êàª„Çä„Åæ„Åó„Åü');
            };

            modal.classList.add('show');
        }

        function loadNextQuiz() {
            let allProblems = [];
            selectedCategories.forEach(categoryId => {
                // problemDatabase„ÇíÊ≠£„Åó„ÅèÂèÇÁÖß
                if (typeof window.problemDatabase !== 'undefined' && window.problemDatabase && window.problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(window.problemDatabase[categoryId]);
                } else if (typeof problemDatabase !== 'undefined' && problemDatabase && problemDatabase[categoryId]) {
                    allProblems = allProblems.concat(problemDatabase[categoryId]);
                }
            });

            if (allProblems.length === 0) return;

            let quiz;
            let remainingCount;

            if (questionMode === 'random') {
                if (usedQuestions.length >= allProblems.length) {
                    usedQuestions = [];
                    showNotification('üéâ ÂÖ®Âïè„ÇØ„É™„Ç¢ÔºÅÂïèÈ°å„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
                }

                const availableQuestions = allProblems.filter((_, index) => !usedQuestions.includes(index));
                if (availableQuestions.length === 0) return;

                const randomIndex = Math.floor(Math.random() * availableQuestions.length);
                quiz = availableQuestions[randomIndex];
                const originalIndex = allProblems.indexOf(quiz);
                usedQuestions.push(originalIndex);
                remainingCount = allProblems.length - usedQuestions.length;
            } else {
                if (sequentialIndex >= allProblems.length) {
                    sequentialIndex = 0;
                    showNotification('üîÑ ÂÖ®ÂïèÈ°å„Çí‰∏ÄÂë®„Åó„Åæ„Åó„ÅüÔºÅÊúÄÂàù„Åã„ÇâÂÜçÈñã„Åó„Åæ„Åô');
                }
                quiz = allProblems[sequentialIndex];
                sequentialIndex++;
                remainingCount = allProblems.length - sequentialIndex;
                if (remainingCount < 0) remainingCount = 0;
            }

            const qEl = document.getElementById('quizQ');
            const optDiv = document.getElementById('quizOptions');
            const msgEl = document.getElementById('quizMsg');
            const explanationEl = document.getElementById('quizExplanation');
            const nextBtn = document.getElementById('quizNext');
            const backBtn = document.getElementById('quizBack');

            qEl.textContent = `${quiz.q} (ÊÆã„Çä${remainingCount}Âïè)`;
            optDiv.innerHTML = '';
            msgEl.textContent = '';
            explanationEl.classList.remove('has-content');

            nextBtn.disabled = true;
            nextBtn.style.opacity = '0.3';
            backBtn.disabled = true;
            backBtn.style.opacity = '0.3';

            let firstAnswer = false;

            quiz.opts.forEach((txt, i) => {
                const btn = document.createElement('button');
                btn.textContent = txt;
                btn.className = 'quiz-option w-full';
                btn.onclick = () => {
                    if (!firstAnswer) {
                        firstAnswer = true;
                        totalQuestionsAnswered++;

                        if (i === quiz.ans) {
                            totalCorrectAnswers++;
                            soundSystem.playCorrect();
                            coins += 100;
                            createParticle('üí∞ +100', '#00ffff', window.innerWidth / 2, window.innerHeight / 2);
                            showNotification('Ê≠£Ëß£ÔºÅ„Ç≥„Ç§„É≥Áç≤ÂæóÔºÅ');
                        } else {
                            soundSystem.playWrong();
                        }

                        renderStats();
                        checkAchievements();

                        nextBtn.disabled = false;
                        nextBtn.style.opacity = '1';
                        backBtn.disabled = false;
                        backBtn.style.opacity = '1';
                    }

                    if (i === quiz.ans) {
                        msgEl.innerHTML = `üéâ Ê≠£Ëß£ÔºÅ${quiz.exp || ''}`;
                        msgEl.style.color = '#00ff41';
                    } else {
                        msgEl.innerHTML = `‚ùå ‰∏çÊ≠£Ëß£„ÄÇÊ≠£Ëß£„ÅØ„Äå${quiz.opts[quiz.ans]}„Äç„Åß„Åô„ÄÇ${quiz.exp || ''}`;
                        msgEl.style.color = '#ff8800';
                    }
                    explanationEl.classList.add('has-content');

                    if (autoQuestEnabled && autoQuestInterval === 0) {
                        setTimeout(() => {
                            loadNextQuiz();
                        }, 1500);
                    }
                };
                optDiv.appendChild(btn);
            });
        }

        /* ----------------- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂàùÊúüÂåñ ----------------- */
        function initEventListeners() {
            // ÂçòÂÖÉÈÅ∏Êäû„Åã„Çâ„Ç≤„Éº„É†ÈñãÂßã
            document.getElementById('startSelectedQuiz').addEventListener('click', () => {
                soundSystem.playLevelUp();
                startSelectedQuiz();
            });

            // ÊïôÁßëÈÅ∏Êäû„Å´Êàª„Çã
            document.getElementById('backToSubjects').addEventListener('click', () => {
                soundSystem.playClick();
                document.getElementById('unitSelectionModal').classList.remove('show');
                document.getElementById('subjectModal').classList.add('show');
            });

            // Âá∫È°åÂΩ¢ÂºèÂàá„ÇäÊõø„Åà„Éú„Çø„É≥
            document.getElementById('randomModeBtn').addEventListener('click', () => {
                soundSystem.playClick();
                setQuestionMode('random');
            });

            document.getElementById('sequentialModeBtn').addEventListener('click', () => {
                soundSystem.playClick();
                setQuestionMode('sequential');
            });

            // ÊïôÁßëÂ§âÊõ¥„Éú„Çø„É≥
            document.getElementById('changeSubject').addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                soundSystem.playClick();
                selectedSubjects = [];
                selectedCategories = [];
                sequentialIndex = 0;
                usedQuestions = [];
                document.getElementById('gameScreen').classList.add('hidden');
                document.getElementById('changeSubject').classList.add('hidden');
                document.getElementById('subjectModal').classList.add('show');
            });
        }

        function startSelectedQuiz() {
            document.getElementById('unitSelectionModal').classList.remove('show');
            document.getElementById('gameScreen').classList.remove('hidden');
            document.getElementById('changeSubject').classList.remove('hidden');

            const subjectNames = {
                'geography_1': 'üó∫Ô∏è ‰∏≠ÔºëÂú∞ÁêÜ',
                'geography_2': 'üóæ ‰∏≠ÔºíÂú∞ÁêÜ',
                'history_1': '‚õ©Ô∏è ‰∏≠ÔºëÊ≠¥Âè≤',
                'history_2': 'üèØ ‰∏≠ÔºíÊ≠¥Âè≤',
                'history_3': 'üè≠ ‰∏≠ÔºìÊ≠¥Âè≤',
                'civics': '‚öñÔ∏è ÂÖ¨Ê∞ë',
                'chemistry_1': 'üß™ ‰∏≠ÔºëÂåñÂ≠¶',
                'chemistry_2': '‚öõÔ∏è ‰∏≠ÔºíÂåñÂ≠¶',
                'chemistry_3': '‚ö° ‰∏≠ÔºìÂåñÂ≠¶',
                'biology_1': 'üå± ‰∏≠ÔºëÁîüÁâ©',
                'biology_2': 'üêæ ‰∏≠ÔºíÁîüÁâ©',
                'biology_3': 'üß¨ ‰∏≠ÔºìÁîüÁâ©',
                'physics_1': 'üí° ‰∏≠ÔºëÁâ©ÁêÜ',
                'physics_2': '‚ö° ‰∏≠ÔºíÁâ©ÁêÜ',
                'physics_3': 'üöÄ ‰∏≠ÔºìÁâ©ÁêÜ',
                'earth_1': 'üèîÔ∏è ‰∏≠ÔºëÂú∞Â≠¶',
                'earth_2': 'üå§Ô∏è ‰∏≠ÔºíÂú∞Â≠¶',
                'earth_3': 'üåå ‰∏≠ÔºìÂú∞Â≠¶'
            };

            const selectedNames = selectedSubjects.map(id => subjectNames[id]).join('„Éª');
            currentSubjectDiv.textContent = `${selectedNames} - ${selectedCategories.length}ÂçòÂÖÉÈÅ∏Êäû`;

            usedQuestions = [];
            sequentialIndex = 0;

            renderStats();
            renderEnemy();
            startBattleLoop();
            updateAutoQuestUI();

            showNotification(`${selectedNames}„ÅÆ${selectedCategories.length}ÂçòÂÖÉ„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„ÅüÔºÅ`);
        }

        /* ----------------- „Éá„Éº„Çø„Çª„Éº„Éñ/„É≠„Éº„ÉâÊ©üËÉΩ ----------------- */
        function saveGame() {
            const gameData = {
                coins: coins,
                dps: dps,
                critRate: critRate,
                defense: defense,
                killCount: killCount,
                attackCost: attackCost,
                critCost: critCost,
                defenseCost: defenseCost,
                selectedSubjects: selectedSubjects,
                selectedCategories: selectedCategories,
                questionMode: questionMode,
                usedQuestions: usedQuestions,
                sequentialIndex: sequentialIndex,
                achievements: achievements || {},
                totalQuestionsAnswered: totalQuestionsAnswered || 0,
                totalCorrectAnswers: totalCorrectAnswers || 0,
                playTime: playTime || 0,
                lastSaveTime: Date.now()
            };
            localStorage.setItem('jukenquest_save', JSON.stringify(gameData));
            showNotification('üíæ „Ç≤„Éº„É†„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
        }

        function loadGame() {
            const saved = localStorage.getItem('jukenquest_save');
            if (saved) {
                try {
                    const gameData = JSON.parse(saved);
                    coins = gameData.coins || 0;
                    dps = gameData.dps || 10;
                    critRate = gameData.critRate || 5;
                    defense = gameData.defense || 0;
                    killCount = gameData.killCount || 0;
                    attackCost = gameData.attackCost || 100;
                    critCost = gameData.critCost || 200;
                    defenseCost = gameData.defenseCost || 150;
                    selectedSubjects = gameData.selectedSubjects || [];
                    selectedCategories = gameData.selectedCategories || [];
                    questionMode = gameData.questionMode || 'random';
                    usedQuestions = gameData.usedQuestions || [];
                    sequentialIndex = gameData.sequentialIndex || 0;
                    achievements = gameData.achievements || {};
                    totalQuestionsAnswered = gameData.totalQuestionsAnswered || 0;
                    totalCorrectAnswers = gameData.totalCorrectAnswers || 0;
                    playTime = gameData.playTime || 0;

                    showNotification('üìÇ „Ç≤„Éº„É†„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                    return true;
                } catch (e) {
                    console.error('„Çª„Éº„Éñ„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó:', e);
                    return false;
                }
            }
            return false;
        }

        setInterval(saveGame, 30000);

        const achievementList = {
            'first_correct': { name: 'ÂàùÂõûÊ≠£Ëß£', desc: 'Âàù„ÇÅ„Å¶ÂïèÈ°å„Å´Ê≠£Ëß£„Åô„Çã', reward: 500, icon: 'üéØ' },
            'questions_10': { name: 'Â≠¶ÁøíËÄÖ', desc: '10Âïè„Å´ÊåëÊà¶„Åô„Çã', reward: 1000, icon: 'üìö' },
            'questions_50': { name: 'ÂãâÂº∑ÂÆ∂', desc: '50Âïè„Å´ÊåëÊà¶„Åô„Çã', reward: 2500, icon: 'üéì' },
            'questions_100': { name: 'Â≠¶Âïè„ÅÆÊé¢Ê±ÇËÄÖ', desc: '100Âïè„Å´ÊåëÊà¶„Åô„Çã', reward: 5000, icon: 'üî¨' },
            'correct_50': { name: 'Áü•Ë≠ò„ÅÆËìÑÁ©ç', desc: '50ÂïèÊ≠£Ëß£„Åô„Çã', reward: 3000, icon: 'üí°' },
            'kill_100': { name: '„É¢„É≥„Çπ„Çø„Éº„Çπ„É¨„Ç§„É§„Éº', desc: '100‰ΩìÊíÉÁ†¥„Åô„Çã', reward: 2000, icon: '‚öîÔ∏è' },
            'coins_10000': { name: 'ÂØåË±™', desc: '10,000„Ç≥„Ç§„É≥Áç≤Âæó', reward: 0, icon: 'üí∞' },
            'play_time_1h': { name: 'Á∂ôÁ∂ö„ÅØÂäõ„Å™„Çä', desc: '1ÊôÇÈñì„Éó„É¨„Ç§', reward: 1500, icon: '‚è∞' }
        };

        function checkAchievements() {
            const checks = [
                { id: 'first_correct', condition: totalCorrectAnswers >= 1 },
                { id: 'questions_10', condition: totalQuestionsAnswered >= 10 },
                { id: 'questions_50', condition: totalQuestionsAnswered >= 50 },
                { id: 'questions_100', condition: totalQuestionsAnswered >= 100 },
                { id: 'correct_50', condition: totalCorrectAnswers >= 50 },
                { id: 'kill_100', condition: killCount >= 100 },
                { id: 'coins_10000', condition: coins >= 10000 },
                { id: 'play_time_1h', condition: playTime >= 3600 }
            ];

            checks.forEach(check => {
                if (check.condition && !achievements[check.id]) {
                    unlockAchievement(check.id);
                }
            });
        }

        function unlockAchievement(id) {
            const achievement = achievementList[id];
            if (!achievement) return;

            achievements[id] = true;
            coins += achievement.reward;

            soundSystem.playLevelUp();
            showNotification(`üèÜ ÂÆüÁ∏æËß£Èô§: ${achievement.name}ÔºÅ+${achievement.reward}„Ç≥„Ç§„É≥`);
            createParticle(
                `üèÜ ${achievement.icon} ${achievement.name}`,
                '#FFD700',
                window.innerWidth / 2,
                window.innerHeight / 4
            );
        }

        function getAccuracyRate() {
            return totalQuestionsAnswered > 0 ? Math.round((totalCorrectAnswers / totalQuestionsAnswered) * 100) : 0;
        }

        function formatPlayTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;

            if (hours > 0) return `${hours}h ${minutes}m`;
            if (minutes > 0) return `${minutes}m ${secs}s`;
            return `${secs}s`;
        }

        setInterval(() => {
            playTime++;
            checkAchievements();
        }, 1000);

        /* ----------------- ÂàùÊúüÂåñ ----------------- */
        document.addEventListener('DOMContentLoaded', () => {
            const loaded = loadGame();

            initSubjectSelection();
            initUpgradeButtons();
            initAutoQuestControls();
            initEventListeners();

            if (loaded && selectedSubjects.length > 0 && selectedCategories.length > 0) {
                document.getElementById('subjectModal').classList.remove('show');

                const subjectNames = {
                    'geography_1': 'üó∫Ô∏è ‰∏≠ÔºëÂú∞ÁêÜ',
                    'geography_2': 'üóæ ‰∏≠ÔºíÂú∞ÁêÜ',
                    'history_1': '‚õ©Ô∏è ‰∏≠ÔºëÊ≠¥Âè≤',
                    'history_2': 'üèØ ‰∏≠ÔºíÊ≠¥Âè≤',
                    'history_3': 'üè≠ ‰∏≠ÔºìÊ≠¥Âè≤',
                    'civics': '‚öñÔ∏è ÂÖ¨Ê∞ë',
                    'chemistry_1': 'üß™ ‰∏≠ÔºëÂåñÂ≠¶',
                    'chemistry_2': '‚öõÔ∏è ‰∏≠ÔºíÂåñÂ≠¶',
                    'chemistry_3': '‚ö° ‰∏≠ÔºìÂåñÂ≠¶',
                    'biology_1': 'üå± ‰∏≠ÔºëÁîüÁâ©',
                    'biology_2': 'üêæ ‰∏≠ÔºíÁîüÁâ©',
                    'biology_3': 'üß¨ ‰∏≠ÔºìÁîüÁâ©',
                    'physics_1': 'üí° ‰∏≠ÔºëÁâ©ÁêÜ',
                    'physics_2': '‚ö° ‰∏≠ÔºíÁâ©ÁêÜ',
                    'physics_3': 'üöÄ ‰∏≠ÔºìÁâ©ÁêÜ',
                    'earth_1': 'üèîÔ∏è ‰∏≠ÔºëÂú∞Â≠¶',
                    'earth_2': 'üå§Ô∏è ‰∏≠ÔºíÂú∞Â≠¶',
                    'earth_3': 'üåå ‰∏≠ÔºìÂú∞Â≠¶'
                };

                document.getElementById('gameScreen').classList.remove('hidden');
                document.getElementById('changeSubject').classList.remove('hidden');

                const selectedNames = selectedSubjects.map(id => subjectNames[id]).join('„Éª');
                currentSubjectDiv.textContent = `${selectedNames} - ${selectedCategories.length}ÂçòÂÖÉÈÅ∏Êäû`;

                if (questionMode === 'sequential') {
                    setQuestionMode('sequential');
                } else {
                    setQuestionMode('random');
                }

                renderStats();
                renderEnemy();
                startBattleLoop();
                updateAutoQuestUI();
            }

            document.addEventListener('click', () => {
                if (soundSystem.audioContext && soundSystem.audioContext.state === 'suspended') {
                    soundSystem.audioContext.resume();
                }
            }, { once: true });
        });
    </script>
</body>
</html>