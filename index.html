<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JUKENâ˜…QUEST â€“ Enhanced Daily Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: "Noto Sans JP", sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .modal { 
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.8); 
      align-items: center; 
      justify-content: center; 
      backdrop-filter: blur(5px);
      z-index: 1000;
    }
    .modal.show { display: flex; }
    
    .game-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .hp-bar {
      transition: width 0.5s ease-in-out;
      background: linear-gradient(90deg, #ef4444, #f97316, #eab308);
    }
    
    .particle {
      position: absolute;
      pointer-events: none;
      font-weight: bold;
      z-index: 100;
      animation: floatUp 2s ease-out forwards;
    }
    
    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-100px) scale(1.2); opacity: 0; }
    }
    
    .shake {
      animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .bounce {
      animation: bounce 0.6s ease-in-out;
    }
    
    .glow {
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      transform: translateX(400px);
      transition: transform 0.3s ease-in-out;
      z-index: 1001;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .progress-ring {
      transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
      transition: stroke-dashoffset 0.35s;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-6 gap-6 relative overflow-x-hidden">

<!-- ã‚¿ã‚¤ãƒˆãƒ« -->
<div class="game-card p-6 text-center">
  <h1 class="text-4xl font-black bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
    JUKENâ˜…QUEST 
    <span class="text-lg font-normal text-gray-600">(Enhanced Daily)</span>
  </h1>
</div>

<!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ± -->
<div class="game-card p-6 w-full max-w-4xl">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="space-y-4">
      <h3 class="font-bold text-lg text-gray-800">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±</h3>
      <div id="stats" class="space-y-2 text-sm"></div>
      <div class="flex items-center gap-3">
        <span class="text-sm font-medium">Lv.</span>
        <div class="flex-1 bg-gray-200 rounded-full h-3">
          <div id="expBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500"></div>
        </div>
        <span id="expText" class="text-xs text-gray-600"></span>
      </div>
    </div>
    
    <!-- æ•µæƒ…å ± -->
    <div class="space-y-4">
      <h3 class="font-bold text-lg text-gray-800">æ•µæƒ…å ±</h3>
      <div id="enemyInfo" class="space-y-2">
        <div id="enemyName" class="font-medium"></div>
        <div class="bg-gray-200 rounded-full h-4">
          <div id="hpBar" class="hp-bar h-4 rounded-full"></div>
        </div>
        <div id="enemyStats" class="text-xs text-gray-600"></div>
      </div>
    </div>
    
    <!-- å®Ÿç¸¾ -->
    <div class="space-y-4">
      <h3 class="font-bold text-lg text-gray-800">å®Ÿç¸¾</h3>
      <div id="achievements" class="space-y-1 max-h-32 overflow-y-auto"></div>
    </div>
  </div>
</div>

<!-- å¼·åŒ–ãƒœã‚¿ãƒ³ -->
<div class="game-card p-6 w-full max-w-4xl">
  <h3 class="font-bold text-lg text-gray-800 mb-4">å¼·åŒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <button id="upgradeAttack" class="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed">
      <div class="font-bold">æ”»æ’ƒåŠ›ã‚¢ãƒƒãƒ—</div>
      <div class="text-sm opacity-90">ï¿¥<span id="attackCost">100</span></div>
    </button>
    
    <button id="upgradeCrit" class="px-6 py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed">
      <div class="font-bold">ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡ã‚¢ãƒƒãƒ—</div>
      <div class="text-sm opacity-90">ï¿¥<span id="critCost">200</span></div>
    </button>
    
    <button id="upgradeDefense" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed">
      <div class="font-bold">é˜²å¾¡åŠ›ã‚¢ãƒƒãƒ—</div>
      <div class="text-sm opacity-90">ï¿¥<span id="defenseCost">150</span></div>
    </button>
  </div>
</div>

<!-- éŸ³æ¥½ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
<div class="fixed bottom-4 right-4 space-y-2">
  <button id="musicToggle" class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300">
    ğŸµ
  </button>
  <button id="sfxToggle" class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300">
    ğŸ”Š
  </button>
</div>

<!-- ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="quizModal" class="modal">
  <div class="game-card p-8 w-96 max-w-[90vw] relative">
    <div class="text-center mb-6">
      <h2 class="font-black text-2xl bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
        ğŸ“š ã‚¯ã‚¤ã‚ºã‚¿ã‚¤ãƒ ï¼
      </h2>
      <div class="mt-2">
        <svg class="progress-ring w-16 h-16 mx-auto" width="64" height="64">
          <circle class="progress-ring-circle" stroke="#e5e7eb" stroke-width="4" fill="transparent" r="28" cx="32" cy="32"/>
          <circle id="quizTimer" class="progress-ring-circle" stroke="#10b981" stroke-width="4" fill="transparent" r="28" cx="32" cy="32" stroke-dasharray="175.929" stroke-dashoffset="175.929"/>
        </svg>
      </div>
    </div>
    
    <div class="space-y-4">
      <p id="quizQ" class="text-lg font-medium text-center"></p>
      <div id="quizOptions" class="space-y-3"></div>
      <p id="quizMsg" class="mt-6 font-bold text-center text-lg"></p>
      <button id="quizClose" class="mt-4 w-full px-4 py-2 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg hidden hover:from-gray-600 hover:to-gray-700 transition-all duration-300">
        é–‰ã˜ã‚‹
      </button>
    </div>
  </div>
</div>

<!-- å®Ÿç¸¾é€šçŸ¥ -->
<div id="notification" class="notification">
  <div class="flex items-center gap-3">
    <span class="text-2xl">ğŸ†</span>
    <div>
      <div class="font-bold">å®Ÿç¸¾è§£é™¤ï¼</div>
      <div id="notificationText" class="text-sm opacity-90"></div>
    </div>
  </div>
</div>

<script>
/* ----------------- åŸºæœ¬ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ ----------------- */
let coins = 0;
let dps = 10;
let critRate = 5; // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡ï¼ˆ%ï¼‰
let defense = 0;
let enemyHPMax = 100;
let enemyHP = enemyHPMax;
let killCount = 0;
let quizTimer = 0;
let quizTimeLeft = 30;
let playerLevel = 1;
let playerExp = 0;
let playerExpMax = 100;
let musicEnabled = true;
let sfxEnabled = true;

// ã‚³ã‚¹ãƒˆç®¡ç†
let attackCost = 100;
let critCost = 200;
let defenseCost = 150;

// å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ 
const achievements = [
  { id: 'first_kill', name: 'åˆæ’ƒç ´', desc: 'æœ€åˆã®æ•µã‚’å€’ã™', condition: () => killCount >= 1, unlocked: false },
  { id: 'ten_kills', name: 'é€£ç¶šæ’ƒç ´', desc: '10ä½“ã®æ•µã‚’å€’ã™', condition: () => killCount >= 10, unlocked: false },
  { id: 'hundred_kills', name: 'ç™¾äººæ–¬ã‚Š', desc: '100ä½“ã®æ•µã‚’å€’ã™', condition: () => killCount >= 100, unlocked: false },
  { id: 'rich', name: 'ãŠé‡‘æŒã¡', desc: '1000ã‚³ã‚¤ãƒ³è²¯ã‚ã‚‹', condition: () => coins >= 1000, unlocked: false },
  { id: 'level_5', name: 'ãƒ¬ãƒ™ãƒ«5', desc: 'ãƒ¬ãƒ™ãƒ«5ã«åˆ°é”', condition: () => playerLevel >= 5, unlocked: false },
  { id: 'level_10', name: 'ãƒ¬ãƒ™ãƒ«10', desc: 'ãƒ¬ãƒ™ãƒ«10ã«åˆ°é”', condition: () => playerLevel >= 10, unlocked: false },
  { id: 'high_attack', name: 'å¼·åŠ›ãªæ”»æ’ƒ', desc: 'æ”»æ’ƒåŠ›100ä»¥ä¸Š', condition: () => dps >= 100, unlocked: false },
  { id: 'crit_master', name: 'ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒã‚¹ã‚¿ãƒ¼', desc: 'ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡30%ä»¥ä¸Š', condition: () => critRate >= 30, unlocked: false },
  { id: 'defender', name: 'å®ˆã‚Šã®é”äºº', desc: 'é˜²å¾¡åŠ›50ä»¥ä¸Š', condition: () => defense >= 50, unlocked: false },
  { id: 'quiz_master', name: 'ã‚¯ã‚¤ã‚ºãƒã‚¹ã‚¿ãƒ¼', desc: 'ã‚¯ã‚¤ã‚ºã«10å›æ­£è§£', condition: () => localStorage.getItem('quizCorrect') >= 10, unlocked: false }
];

// DOMè¦ç´ 
const enemyName = document.getElementById('enemyName');
const hpBar = document.getElementById('hpBar');
const statsDiv = document.getElementById('stats');
const expBar = document.getElementById('expBar');
const expText = document.getElementById('expText');
const achievementsDiv = document.getElementById('achievements');

/* ----------------- å…¨å•é¡Œãƒ—ãƒ¼ãƒ« ----------------- */
const quizAll = [
  {q:'æ—¥æœ¬å›½æ†²æ³•æ–½è¡Œå¹´ã¯ï¼Ÿ',opts:['1945','1946','1947'],ans:2},
  {q:'å…ƒç´ è¨˜å·Feã¯ï¼Ÿ',opts:['éŠ…','é‰„','éŠ€'],ans:1},
  {q:'walkã®éå»å½¢ã¯ï¼Ÿ',opts:['walked','walking','walks'],ans:0},
  {q:'ä¸‰è§’å½¢ã®å†…è§’å’Œã¯ï¼Ÿ',opts:['90Â°','180Â°','360Â°'],ans:1},
  {q:'æ²–ç¸„ã®çœŒåºæ‰€åœ¨åœ°ã¯ï¼Ÿ',opts:['é‚£è¦‡','åå¤å±‹','é•·å´'],ans:0},
  {q:'å††å‘¨ç‡Ï€ã‚’å°æ•°ç¬¬ä¸€ä½ã¾ã§',opts:['3.1','3.2','3.3'],ans:0},
  {q:'æ°´ã¯ä½•åº¦ã§å‡ã‚‹ï¼Ÿ',opts:['0â„ƒ','4â„ƒ','10â„ƒ'],ans:0},
  {q:'ä¸–ç•Œæœ€å¤§ã®å¤§é™¸ã¯ï¼Ÿ',opts:['ã‚¢ã‚¸ã‚¢','ã‚¢ãƒ•ãƒªã‚«','å—æ¥µ'],ans:0},
  {q:'å…‰åˆæˆã«å¿…è¦ãªæ°—ä½“ã¯ï¼Ÿ',opts:['äºŒé…¸åŒ–ç‚­ç´ ','é…¸ç´ ','çª’ç´ '],ans:0},
  {q:'åœ°çƒã‚’å›ã‚‹è¡›æ˜Ÿã¯ï¼Ÿ',opts:['æœˆ','ç«æ˜Ÿ','é‡‘æ˜Ÿ'],ans:0},
  {q:'æ—¥æœ¬ã®é¦–éƒ½ã¯ï¼Ÿ',opts:['å¤§é˜ª','æ±äº¬','äº¬éƒ½'],ans:1},
  {q:'1+1=ï¼Ÿ',opts:['1','2','3'],ans:1},
  {q:'å¤ªé™½ç³»ã§æœ€å¤§ã®æƒ‘æ˜Ÿã¯ï¼Ÿ',opts:['åœ°çƒ','æœ¨æ˜Ÿ','åœŸæ˜Ÿ'],ans:1},
  {q:'å¯Œå£«å±±ã®é«˜ã•ã¯ç´„ï¼Ÿ',opts:['3776m','2776m','4776m'],ans:0},
  {q:'æ—¥æœ¬ã§ä¸€ç•ªé•·ã„å·ã¯ï¼Ÿ',opts:['åˆ©æ ¹å·','ä¿¡æ¿ƒå·','çŸ³ç‹©å·'],ans:1}
];

/* ---------- ä»Šæ—¥ã®å•é¡Œã‚»ãƒƒãƒˆ ---------- */
const daySeed = Math.floor(Date.now() / 86400000);

function todaysQuizPool() {
  let rng = daySeed, pool = [...quizAll];
  for (let i = pool.length - 1; i > 0; i--) {
    rng = (rng * 9301 + 49297) % 233280;
    const j = Math.floor(rng / 233280 * (i + 1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }
  return pool.slice(0, 10);
}
let quizPool = todaysQuizPool();

/* ----------------- ã‚¨ãƒ•ã‚§ã‚¯ãƒˆé–¢æ•° ----------------- */
function createParticle(text, color, x, y) {
  const particle = document.createElement('div');
  particle.className = 'particle';
  particle.textContent = text;
  particle.style.color = color;
  particle.style.left = x + 'px';
  particle.style.top = y + 'px';
  particle.style.fontSize = '18px';
  document.body.appendChild(particle);
  
  setTimeout(() => {
    if (particle.parentNode) {
      particle.parentNode.removeChild(particle);
    }
  }, 2000);
}

function playSound(type) {
  if (!sfxEnabled) return;
  
  // Web Audio APIã‚’ä½¿ç”¨ã—ãŸç°¡å˜ãªåŠ¹æœéŸ³ç”Ÿæˆ
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  switch(type) {
    case 'attack':
      oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(220, audioContext.currentTime + 0.1);
      break;
    case 'levelup':
      oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1);
      oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.2);
      break;
    case 'coin':
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
      break;
    case 'correct':
      oscillator.frequency.setValueAtTime(659, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.1);
      break;
    case 'wrong':
      oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(196, audioContext.currentTime + 0.2);
      break;
  }
  
  gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.3);
}

function showNotification(text) {
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notificationText');
  
  notificationText.textContent = text;
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

/* ----------------- ãƒ¬ãƒ™ãƒ«ã‚·ã‚¹ãƒ†ãƒ  ----------------- */
function gainExp(amount) {
  playerExp += amount;
  if (playerExp >= playerExpMax) {
    playerLevel++;
    playerExp = 0;
    playerExpMax = Math.floor(playerExpMax * 1.5);
    playSound('levelup');
    createParticle('LEVEL UP!', '#10b981', window.innerWidth / 2, window.innerHeight / 2);
    showNotification(`ãƒ¬ãƒ™ãƒ«${playerLevel}ã«ä¸ŠãŒã‚Šã¾ã—ãŸï¼`);
    
    // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ãƒœãƒ¼ãƒŠã‚¹
    coins += playerLevel * 50;
    dps += playerLevel * 2;
  }
}

/* ----------------- å®Ÿç¸¾ã‚·ã‚¹ãƒ†ãƒ  ----------------- */
function checkAchievements() {
  achievements.forEach(achievement => {
    if (!achievement.unlocked && achievement.condition()) {
      achievement.unlocked = true;
      showNotification(achievement.name + ': ' + achievement.desc);
      playSound('levelup');
      coins += 200; // å®Ÿç¸¾ãƒœãƒ¼ãƒŠã‚¹
    }
  });
}

function renderAchievements() {
  achievementsDiv.innerHTML = '';
  achievements.forEach(achievement => {
    const div = document.createElement('div');
    div.className = `text-xs p-2 rounded ${achievement.unlocked ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'}`;
    div.innerHTML = `
      <div class="font-medium">${achievement.unlocked ? 'ğŸ†' : 'ğŸ”’'} ${achievement.name}</div>
      <div class="text-xs opacity-75">${achievement.desc}</div>
    `;
    achievementsDiv.appendChild(div);
  });
}

/* ----------------- ç”»é¢æ›´æ–° ----------------- */
function renderStats() {
  statsDiv.innerHTML = `
    <div><span class="font-medium">ã‚³ã‚¤ãƒ³:</span> <span class="font-bold text-yellow-600">${coins.toLocaleString()}</span></div>
    <div><span class="font-medium">æ”»æ’ƒåŠ›:</span> <span class="font-bold text-red-600">${dps}/ç§’</span></div>
    <div><span class="font-medium">ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡:</span> <span class="font-bold text-yellow-600">${critRate}%</span></div>
    <div><span class="font-medium">é˜²å¾¡åŠ›:</span> <span class="font-bold text-blue-600">${defense}</span></div>
    <div><span class="font-medium">ãƒ¬ãƒ™ãƒ«:</span> <span class="font-bold text-purple-600">${playerLevel}</span></div>
    <div><span class="font-medium">æ’ƒç ´æ•°:</span> <span class="font-bold text-gray-600">${killCount}</span></div>
  `;
  
  // çµŒé¨“å€¤ãƒãƒ¼
  const expPercent = (playerExp / playerExpMax) * 100;
  expBar.style.width = expPercent + '%';
  expText.textContent = `${playerExp}/${playerExpMax}`;
  
  // ã‚³ã‚¹ãƒˆæ›´æ–°
  document.getElementById('attackCost').textContent = attackCost;
  document.getElementById('critCost').textContent = critCost;
  document.getElementById('defenseCost').textContent = defenseCost;
  
  // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹
  document.getElementById('upgradeAttack').disabled = coins < attackCost;
  document.getElementById('upgradeCrit').disabled = coins < critCost;
  document.getElementById('upgradeDefense').disabled = coins < defenseCost;
}

function renderEnemy() {
  const enemyTypes = ['ãƒ†ã‚¹ãƒˆãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼', 'ã‚¯ã‚¤ã‚ºãƒ‰ãƒ©ã‚´ãƒ³', 'æ•°å­¦ã‚¹ãƒ©ã‚¤ãƒ ', 'è‹±èªã‚´ãƒ–ãƒªãƒ³', 'ç†ç§‘ã‚ªãƒ¼ã‚¯'];
  const currentEnemyType = enemyTypes[Math.floor(killCount / 10) % enemyTypes.length];
  
  enemyName.textContent = `${currentEnemyType} Lv.${Math.floor(killCount / 5) + 1}`;
  
  const hpPercent = (enemyHP / enemyHPMax) * 100;
  hpBar.style.width = hpPercent + '%';
  
  // HPãƒãƒ¼ã®è‰²å¤‰æ›´
  if (hpPercent > 60) {
    hpBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
  } else if (hpPercent > 30) {
    hpBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
  } else {
    hpBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
  }
  
  document.getElementById('enemyStats').textContent = `HP: ${enemyHP}/${enemyHPMax}`;
}

/* ----------------- ãƒãƒˆãƒ«ãƒ«ãƒ¼ãƒ— ----------------- */
setInterval(() => {
  // ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«åˆ¤å®š
  const isCrit = Math.random() * 100 < critRate;
  const damage = isCrit ? dps * 2 : dps;
  
  enemyHP -= damage;
  
  // ãƒ€ãƒ¡ãƒ¼ã‚¸è¡¨ç¤º
  const enemyElement = document.getElementById('enemyInfo');
  const rect = enemyElement.getBoundingClientRect();
  createParticle(
    isCrit ? `CRIT! -${damage}` : `-${damage}`,
    isCrit ? '#f59e0b' : '#ef4444',
    rect.left + rect.width / 2,
    rect.top
  );
  
  if (isCrit) {
    enemyElement.classList.add('shake');
    setTimeout(() => enemyElement.classList.remove('shake'), 500);
  }
  
  playSound('attack');
  
  if (enemyHP <= 0) {
    // æ•µæ’ƒç ´
    const coinReward = 50 + Math.floor(killCount / 10) * 25;
    const expReward = 20 + Math.floor(killCount / 5) * 5;
    
    coins += coinReward;
    gainExp(expReward);
    killCount++;
    
    // æ–°ã—ã„æ•µç”Ÿæˆ
    enemyHPMax = Math.round(enemyHPMax * 1.15);
    enemyHP = enemyHPMax;
    
    // ãƒªãƒ¯ãƒ¼ãƒ‰è¡¨ç¤º
    createParticle(`+${coinReward} ã‚³ã‚¤ãƒ³`, '#f59e0b', window.innerWidth / 2 - 50, window.innerHeight / 2 + 50);
    createParticle(`+${expReward} EXP`, '#8b5cf6', window.innerWidth / 2 + 50, window.innerHeight / 2 + 50);
    
    playSound('coin');
    
    // ãƒœã‚¹æˆ¦åˆ¤å®š
    if (killCount % 50 === 0) {
      enemyHPMax *= 3;
      enemyHP = enemyHPMax;
      showNotification('ãƒœã‚¹å‡ºç¾ï¼');
    }
  }
  
  // ã‚¯ã‚¤ã‚ºã‚¿ã‚¤ãƒãƒ¼
  if (++quizTimer >= 20) {
    quizTimer = 0;
    openQuiz();
  }
  
  checkAchievements();
  renderStats();
  renderEnemy();
  renderAchievements();
}, 1000);

/* ----------------- å¼·åŒ–ãƒœã‚¿ãƒ³ ----------------- */
document.getElementById('upgradeAttack').onclick = () => {
  if (coins >= attackCost) {
    coins -= attackCost;
    dps += 15;
    attackCost = Math.floor(attackCost * 1.5);
    playSound('levelup');
    createParticle('æ”»æ’ƒåŠ›UP!', '#ef4444', window.innerWidth / 2, window.innerHeight / 3);
    renderStats();
  }
};

document.getElementById('upgradeCrit').onclick = () => {
  if (coins >= critCost) {
    coins -= critCost;
    critRate += 5;
    critCost = Math.floor(critCost * 1.8);
    playSound('levelup');
    createParticle('ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡UP!', '#f59e0b', window.innerWidth / 2, window.innerHeight / 3);
    renderStats();
  }
};

document.getElementById('upgradeDefense').onclick = () => {
  if (coins >= defenseCost) {
    coins -= defenseCost;
    defense += 10;
    defenseCost = Math.floor(defenseCost * 1.6);
    playSound('levelup');
    createParticle('é˜²å¾¡åŠ›UP!', '#3b82f6', window.innerWidth / 2, window.innerHeight / 3);
    renderStats();
  }
};

/* ----------------- éŸ³æ¥½ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ----------------- */
document.getElementById('musicToggle').onclick = () => {
  musicEnabled = !musicEnabled;
  document.getElementById('musicToggle').textContent = musicEnabled ? 'ğŸµ' : 'ğŸ”‡';
};

document.getElementById('sfxToggle').onclick = () => {
  sfxEnabled = !sfxEnabled;
  document.getElementById('sfxToggle').textContent = sfxEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
};

/* ----------------- ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ€ãƒ« ----------------- */
function openQuiz() {
  if (quizPool.length === 0) quizPool = todaysQuizPool();
  const quiz = quizPool.pop();
  
  const modal = document.getElementById('quizModal');
  const qEl = document.getElementById('quizQ');
  const optDiv = document.getElementById('quizOptions');
  const msg = document.getElementById('quizMsg');
  const close = document.getElementById('quizClose');
  const timerCircle = document.getElementById('quizTimer');
  
  qEl.textContent = quiz.q;
  optDiv.innerHTML = '';
  msg.textContent = '';
  close.classList.add('hidden');
  
  // ã‚¿ã‚¤ãƒãƒ¼åˆæœŸåŒ–
  quizTimeLeft = 30;
  const timerInterval = setInterval(() => {
    quizTimeLeft--;
    const progress = (30 - quizTimeLeft) / 30;
    const offset = 175.929 * (1 - progress);
    timerCircle.style.strokeDashoffset = offset;
    
    if (quizTimeLeft <= 0) {
      clearInterval(timerInterval);
      msg.textContent = 'æ™‚é–“åˆ‡ã‚Œï¼';
      msg.style.color = '#ef4444';
      [...optDiv.children].forEach(b => b.disabled = true);
      close.classList.remove('hidden');
      playSound('wrong');
    }
  }, 1000);
  
  quiz.opts.forEach((txt, i) => {
    const btn = document.createElement('button');
    btn.textContent = txt;
    btn.className = 'w-full px-4 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-lg transition-all duration-300 font-medium';
    btn.onclick = () => {
      clearInterval(timerInterval);
      if (i === quiz.ans) {
        msg.textContent = 'ğŸ‰ æ­£è§£ï¼ã‚³ã‚¤ãƒ³+150ã€EXP+30';
        msg.style.color = '#10b981';
        coins += 150;
        gainExp(30);
        playSound('correct');
        
        // æ­£è§£æ•°ã‚«ã‚¦ãƒ³ãƒˆ
        let correctCount = parseInt(localStorage.getItem('quizCorrect') || '0');
        correctCount++;
        localStorage.setItem('quizCorrect', correctCount);
        
        createParticle('+150 ã‚³ã‚¤ãƒ³', '#f59e0b', window.innerWidth / 2 - 50, window.innerHeight / 2);
        createParticle('+30 EXP', '#8b5cf6', window.innerWidth / 2 + 50, window.innerHeight / 2);
      } else {
        msg.textContent = 'âŒ æ®‹å¿µ...æ­£è§£ã¯ã€Œ' + quiz.opts[quiz.ans] + 'ã€ã§ã—ãŸ';
        msg.style.color = '#ef4444';
        playSound('wrong');
      }
      renderStats();
      [...optDiv.children].forEach(b => b.disabled = true);
      close.classList.remove('hidden');
    };
    optDiv.appendChild(btn);
  });
  
  close.onclick = () => {
    clearInterval(timerInterval);
    modal.classList.remove('show');
  };
  
  modal.classList.add('show');
}

/* ----------------- åˆæœŸåŒ– ----------------- */
function initGame() {
  // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰æ­£è§£æ•°ã‚’å–å¾—
  if (!localStorage.getItem('quizCorrect')) {
    localStorage.setItem('quizCorrect', '0');
  }
  
  renderStats();
  renderEnemy();
  renderAchievements();
  
  // é–‹å§‹æ™‚ã®ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  setTimeout(() => {
    showNotification('JUKENâ˜…QUEST ã¸ã‚ˆã†ã“ãï¼');
  }, 1000);
  
  // èƒŒæ™¯éŸ³æ¥½ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿéš›ã®éŸ³æ¥½ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆï¼‰
  if (musicEnabled) {
    console.log('ğŸµ BGM playing...');
  }
}

/* ----------------- ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ ----------------- */
document.addEventListener('keydown', (e) => {
  switch(e.key) {
    case '1':
      if (coins >= attackCost) document.getElementById('upgradeAttack').click();
      break;
    case '2':
      if (coins >= critCost) document.getElementById('upgradeCrit').click();
      break;
    case '3':
      if (coins >= defenseCost) document.getElementById('upgradeDefense').click();
      break;
    case 'm':
    case 'M':
      document.getElementById('musicToggle').click();
      break;
    case 's':
    case 'S':
      document.getElementById('sfxToggle').click();
      break;
    case 'Escape':
      const modal = document.getElementById('quizModal');
      if (modal.classList.contains('show')) {
        document.getElementById('quizClose').click();
      }
      break;
  }
});

/* ----------------- è¿½åŠ ã®ã‚²ãƒ¼ãƒ æ©Ÿèƒ½ ----------------- */

// ã‚ªãƒ¼ãƒˆã‚»ãƒ¼ãƒ–æ©Ÿèƒ½
setInterval(() => {
  const gameData = {
    coins,
    dps,
    critRate,
    defense,
    playerLevel,
    playerExp,
    playerExpMax,
    killCount,
    attackCost,
    critCost,
    defenseCost
  };
  localStorage.setItem('jukenQuestSave', JSON.stringify(gameData));
}, 10000); // 10ç§’ã”ã¨ã«ã‚»ãƒ¼ãƒ–

// ã‚²ãƒ¼ãƒ ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
function loadGame() {
  const savedData = localStorage.getItem('jukenQuestSave');
  if (savedData) {
    try {
      const data = JSON.parse(savedData);
      coins = data.coins || 0;
      dps = data.dps || 10;
      critRate = data.critRate || 5;
      defense = data.defense || 0;
      playerLevel = data.playerLevel || 1;
      playerExp = data.playerExp || 0;
      playerExpMax = data.playerExpMax || 100;
      killCount = data.killCount || 0;
      attackCost = data.attackCost || 100;
      critCost = data.critCost || 200;
      defenseCost = data.defenseCost || 150;
      
      // æ•µã®HPã‚‚èª¿æ•´
      enemyHPMax = 100 + (killCount * 15);
      enemyHP = enemyHPMax;
      
      showNotification('å‰å›ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼');
    } catch (e) {
      console.log('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    }
  }
}

// ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆéš ã—æ©Ÿèƒ½ï¼‰
function resetGame() {
  if (confirm('æœ¬å½“ã«ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿå…¨ã¦ã®é€²è¡ŒçŠ¶æ³ãŒå¤±ã‚ã‚Œã¾ã™ã€‚')) {
    localStorage.removeItem('jukenQuestSave');
    localStorage.removeItem('quizCorrect');
    location.reload();
  }
}

// ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰
window.addCoins = (amount) => {
  coins += amount;
  renderStats();
  console.log(`${amount} ã‚³ã‚¤ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
};

window.addLevel = (levels) => {
  for (let i = 0; i < levels; i++) {
    gainExp(playerExpMax);
  }
  console.log(`${levels} ãƒ¬ãƒ™ãƒ«è¿½åŠ ã—ã¾ã—ãŸ`);
};

window.resetGameData = resetGame;

// å³ã‚¯ãƒªãƒƒã‚¯ã§ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆéš ã—æ©Ÿèƒ½ï¼‰
document.addEventListener('contextmenu', (e) => {
  if (e.ctrlKey && e.shiftKey) {
    e.preventDefault();
    if (confirm('éš ã—ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼\nã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
      resetGame();
    }
  }
});

// ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œ
let touchStartY = 0;
document.addEventListener('touchstart', (e) => {
  touchStartY = e.touches[0].clientY;
});

document.addEventListener('touchend', (e) => {
  const touchEndY = e.changedTouches[0].clientY;
  const diff = touchStartY - touchEndY;
  
  // ä¸Šã‚¹ãƒ¯ã‚¤ãƒ—ã§ã‚¯ã‚¤ã‚ºã‚’å¼·åˆ¶é–‹å§‹ï¼ˆéš ã—æ©Ÿèƒ½ï¼‰
  if (diff > 100) {
    openQuiz();
  }
});

// ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒ•ã‚©ãƒ¼ã‚«ã‚¹æ™‚ã®å‡¦ç†
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    // ãƒšãƒ¼ã‚¸ã«æˆ»ã£ã¦ããŸæ™‚ã®å‡¦ç†
    renderStats();
    renderEnemy();
    renderAchievements();
  }
});

// ã‚²ãƒ¼ãƒ é–‹å§‹
loadGame();
initGame();

// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
console.log('%cğŸ® JUKENâ˜…QUEST Enhanced Edition', 'color: #10b981; font-size: 20px; font-weight: bold;');
console.log('%cé–‹ç™ºè€…å‘ã‘ã‚³ãƒãƒ³ãƒ‰:', 'color: #3b82f6; font-size: 14px; font-weight: bold;');
console.log('%caddCoins(amount) - ã‚³ã‚¤ãƒ³ã‚’è¿½åŠ ', 'color: #6b7280;');
console.log('%caddLevel(levels) - ãƒ¬ãƒ™ãƒ«ã‚’è¿½åŠ ', 'color: #6b7280;');
console.log('%cresetGameData() - ã‚²ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ', 'color: #6b7280;');
console.log('%cã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ: 1,2,3=å¼·åŒ–, M=éŸ³æ¥½, S=åŠ¹æœéŸ³, ESC=ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹', 'color: #6b7280;');
</script>
</body>
</html>