<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JUKEN★QUEST – Enhanced Daily Edition</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: "Noto Sans JP", sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    
    .modal { 
      display: none; 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.8); 
      align-items: center; 
      justify-content: center; 
      backdrop-filter: blur(5px);
      z-index: 1000;
    }
    .modal.show { display: flex; }
    
    .game-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .hp-bar {
      transition: width 0.5s ease-in-out;
      background: linear-gradient(90deg, #ef4444, #f97316, #eab308);
    }
    
    .particle {
      position: absolute;
      pointer-events: none;
      font-weight: bold;
      z-index: 100;
      animation: floatUp 2s ease-out forwards;
    }
    
    @keyframes floatUp {
      0% { transform: translateY(0) scale(1); opacity: 1; }
      100% { transform: translateY(-100px) scale(1.2); opacity: 0; }
    }
    
    .shake {
      animation: shake 0.5s ease-in-out;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    
    .bounce {
      animation: bounce 0.6s ease-in-out;
    }
    
    .glow {
      box-shadow: 0 0 20px rgba(34, 197, 94, 0.5);
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: linear-gradient(135deg, #10b981, #059669);
      color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      transform: translateX(400px);
      transition: transform 0.3s ease-in-out;
      z-index: 1001;
    }
    
    .notification.show {
      transform: translateX(0);
    }
    
    .progress-ring {
      transform: rotate(-90deg);
    }
    
    .progress-ring-circle {
      transition: stroke-dashoffset 0.35s;
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }
  </style>
</head>
<body class="min-h-screen flex flex-col items-center pt-6 gap-6 relative overflow-x-hidden">

<!-- タイトル -->
<div class="game-card p-6 text-center">
  <h1 class="text-4xl font-black bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
    JUKEN★QUEST 
    <span class="text-lg font-normal text-gray-600">(Enhanced Daily)</span>
  </h1>
</div>

<!-- プレイヤー情報 -->
<div class="game-card p-6 w-full max-w-4xl">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- ステータス -->
    <div class="space-y-4">
      <h3 class="font-bold text-lg text-gray-800">プレイヤー情報</h3>
      <div id="stats" class="space-y-2 text-sm"></div>
      <div class="flex items-center gap-3">
        <span class="text-sm font-medium">Lv.</span>
        <div class="flex-1 bg-gray-200 rounded-full h-3">
          <div id="expBar" class="bg-gradient-to-r from-blue-500 to-purple-600 h-3 rounded-full transition-all duration-500"></div>
        </div>
        <span id="expText" class="text-xs text-gray-600"></span>
      </div>
    </div>
    
    <!-- 敵情報 -->
    <div class="space-y-4">
      <h3 class="font-bold text-lg text-gray-800">敵情報</h3>
      <div id="enemyInfo" class="space-y-2">
        <div id="enemyName" class="font-medium"></div>
        <div class="bg-gray-200 rounded-full h-4">
          <div id="hpBar" class="hp-bar h-4 rounded-full"></div>
        </div>
        <div id="enemyStats" class="text-xs text-gray-600"></div>
      </div>
    </div>
    
    <!-- 実績 -->
    <div class="space-y-4">
      <h3 class="font-bold text-lg text-gray-800">実績</h3>
      <div id="achievements" class="space-y-1 max-h-32 overflow-y-auto"></div>
    </div>
  </div>
</div>

<!-- 強化ボタン -->
<div class="game-card p-6 w-full max-w-4xl">
  <h3 class="font-bold text-lg text-gray-800 mb-4">強化メニュー</h3>
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <button id="upgradeAttack" class="px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed">
      <div class="font-bold">攻撃力アップ</div>
      <div class="text-sm opacity-90">￥<span id="attackCost">100</span></div>
    </button>
    
    <button id="upgradeCrit" class="px-6 py-3 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed">
      <div class="font-bold">クリティカル率アップ</div>
      <div class="text-sm opacity-90">￥<span id="critCost">200</span></div>
    </button>
    
    <button id="upgradeDefense" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 disabled:opacity-40 disabled:cursor-not-allowed">
      <div class="font-bold">防御力アップ</div>
      <div class="text-sm opacity-90">￥<span id="defenseCost">150</span></div>
    </button>
  </div>
</div>

<!-- 音楽コントロール -->
<div class="fixed bottom-4 right-4 space-y-2">
  <button id="musicToggle" class="w-12 h-12 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300">
    🎵
  </button>
  <button id="sfxToggle" class="w-12 h-12 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-300">
    🔊
  </button>
</div>

<!-- クイズモーダル -->
<div id="quizModal" class="modal">
  <div class="game-card p-8 w-96 max-w-[90vw] relative">
    <div class="text-center mb-6">
      <h2 class="font-black text-2xl bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
        📚 クイズタイム！
      </h2>
      <div class="mt-2">
        <svg class="progress-ring w-16 h-16 mx-auto" width="64" height="64">
          <circle class="progress-ring-circle" stroke="#e5e7eb" stroke-width="4" fill="transparent" r="28" cx="32" cy="32"/>
          <circle id="quizTimer" class="progress-ring-circle" stroke="#10b981" stroke-width="4" fill="transparent" r="28" cx="32" cy="32" stroke-dasharray="175.929" stroke-dashoffset="175.929"/>
        </svg>
      </div>
    </div>
    
    <div class="space-y-4">
      <p id="quizQ" class="text-lg font-medium text-center"></p>
      <div id="quizOptions" class="space-y-3"></div>
      <p id="quizMsg" class="mt-6 font-bold text-center text-lg"></p>
      <button id="quizClose" class="mt-4 w-full px-4 py-2 bg-gradient-to-r from-gray-500 to-gray-600 text-white rounded-lg hidden hover:from-gray-600 hover:to-gray-700 transition-all duration-300">
        閉じる
      </button>
    </div>
  </div>
</div>

<!-- 実績通知 -->
<div id="notification" class="notification">
  <div class="flex items-center gap-3">
    <span class="text-2xl">🏆</span>
    <div>
      <div class="font-bold">実績解除！</div>
      <div id="notificationText" class="text-sm opacity-90"></div>
    </div>
  </div>
</div>

<script>
/* ----------------- 基本パラメータ ----------------- */
let coins = 0;
let dps = 10;
let critRate = 5; // クリティカル率（%）
let defense = 0;
let enemyHPMax = 100;
let enemyHP = enemyHPMax;
let killCount = 0;
let quizTimer = 0;
let quizTimeLeft = 30;
let playerLevel = 1;
let playerExp = 0;
let playerExpMax = 100;
let musicEnabled = true;
let sfxEnabled = true;

// コスト管理
let attackCost = 100;
let critCost = 200;
let defenseCost = 150;

// 実績システム
const achievements = [
  { id: 'first_kill', name: '初撃破', desc: '最初の敵を倒す', condition: () => killCount >= 1, unlocked: false },
  { id: 'ten_kills', name: '連続撃破', desc: '10体の敵を倒す', condition: () => killCount >= 10, unlocked: false },
  { id: 'hundred_kills', name: '百人斬り', desc: '100体の敵を倒す', condition: () => killCount >= 100, unlocked: false },
  { id: 'rich', name: 'お金持ち', desc: '1000コイン貯める', condition: () => coins >= 1000, unlocked: false },
  { id: 'level_5', name: 'レベル5', desc: 'レベル5に到達', condition: () => playerLevel >= 5, unlocked: false },
  { id: 'level_10', name: 'レベル10', desc: 'レベル10に到達', condition: () => playerLevel >= 10, unlocked: false },
  { id: 'high_attack', name: '強力な攻撃', desc: '攻撃力100以上', condition: () => dps >= 100, unlocked: false },
  { id: 'crit_master', name: 'クリティカルマスター', desc: 'クリティカル率30%以上', condition: () => critRate >= 30, unlocked: false },
  { id: 'defender', name: '守りの達人', desc: '防御力50以上', condition: () => defense >= 50, unlocked: false },
  { id: 'quiz_master', name: 'クイズマスター', desc: 'クイズに10回正解', condition: () => localStorage.getItem('quizCorrect') >= 10, unlocked: false }
];

// DOM要素
const enemyName = document.getElementById('enemyName');
const hpBar = document.getElementById('hpBar');
const statsDiv = document.getElementById('stats');
const expBar = document.getElementById('expBar');
const expText = document.getElementById('expText');
const achievementsDiv = document.getElementById('achievements');

/* ----------------- 全問題プール ----------------- */
const quizAll = [
  {q:'日本国憲法施行年は？',opts:['1945','1946','1947'],ans:2},
  {q:'元素記号Feは？',opts:['銅','鉄','銀'],ans:1},
  {q:'walkの過去形は？',opts:['walked','walking','walks'],ans:0},
  {q:'三角形の内角和は？',opts:['90°','180°','360°'],ans:1},
  {q:'沖縄の県庁所在地は？',opts:['那覇','名古屋','長崎'],ans:0},
  {q:'円周率πを小数第一位まで',opts:['3.1','3.2','3.3'],ans:0},
  {q:'水は何度で凍る？',opts:['0℃','4℃','10℃'],ans:0},
  {q:'世界最大の大陸は？',opts:['アジア','アフリカ','南極'],ans:0},
  {q:'光合成に必要な気体は？',opts:['二酸化炭素','酸素','窒素'],ans:0},
  {q:'地球を回る衛星は？',opts:['月','火星','金星'],ans:0},
  {q:'日本の首都は？',opts:['大阪','東京','京都'],ans:1},
  {q:'1+1=？',opts:['1','2','3'],ans:1},
  {q:'太陽系で最大の惑星は？',opts:['地球','木星','土星'],ans:1},
  {q:'富士山の高さは約？',opts:['3776m','2776m','4776m'],ans:0},
  {q:'日本で一番長い川は？',opts:['利根川','信濃川','石狩川'],ans:1}
];

/* ---------- 今日の問題セット ---------- */
const daySeed = Math.floor(Date.now() / 86400000);

function todaysQuizPool() {
  let rng = daySeed, pool = [...quizAll];
  for (let i = pool.length - 1; i > 0; i--) {
    rng = (rng * 9301 + 49297) % 233280;
    const j = Math.floor(rng / 233280 * (i + 1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }
  return pool.slice(0, 10);
}
let quizPool = todaysQuizPool();

/* ----------------- エフェクト関数 ----------------- */
function createParticle(text, color, x, y) {
  const particle = document.createElement('div');
  particle.className = 'particle';
  particle.textContent = text;
  particle.style.color = color;
  particle.style.left = x + 'px';
  particle.style.top = y + 'px';
  particle.style.fontSize = '18px';
  document.body.appendChild(particle);
  
  setTimeout(() => {
    if (particle.parentNode) {
      particle.parentNode.removeChild(particle);
    }
  }, 2000);
}

function playSound(type) {
  if (!sfxEnabled) return;
  
  // Web Audio APIを使用した簡単な効果音生成
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  switch(type) {
    case 'attack':
      oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(220, audioContext.currentTime + 0.1);
      break;
    case 'levelup':
      oscillator.frequency.setValueAtTime(523, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1);
      oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.2);
      break;
    case 'coin':
      oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
      oscillator.frequency.exponentialRampToValueAtTime(1200, audioContext.currentTime + 0.1);
      break;
    case 'correct':
      oscillator.frequency.setValueAtTime(659, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.1);
      break;
    case 'wrong':
      oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
      oscillator.frequency.setValueAtTime(196, audioContext.currentTime + 0.2);
      break;
  }
  
  gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
  gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
  
  oscillator.start(audioContext.currentTime);
  oscillator.stop(audioContext.currentTime + 0.3);
}

function showNotification(text) {
  const notification = document.getElementById('notification');
  const notificationText = document.getElementById('notificationText');
  
  notificationText.textContent = text;
  notification.classList.add('show');
  
  setTimeout(() => {
    notification.classList.remove('show');
  }, 3000);
}

/* ----------------- レベルシステム ----------------- */
function gainExp(amount) {
  playerExp += amount;
  if (playerExp >= playerExpMax) {
    playerLevel++;
    playerExp = 0;
    playerExpMax = Math.floor(playerExpMax * 1.5);
    playSound('levelup');
    createParticle('LEVEL UP!', '#10b981', window.innerWidth / 2, window.innerHeight / 2);
    showNotification(`レベル${playerLevel}に上がりました！`);
    
    // レベルアップボーナス
    coins += playerLevel * 50;
    dps += playerLevel * 2;
  }
}

/* ----------------- 実績システム ----------------- */
function checkAchievements() {
  achievements.forEach(achievement => {
    if (!achievement.unlocked && achievement.condition()) {
      achievement.unlocked = true;
      showNotification(achievement.name + ': ' + achievement.desc);
      playSound('levelup');
      coins += 200; // 実績ボーナス
    }
  });
}

function renderAchievements() {
  achievementsDiv.innerHTML = '';
  achievements.forEach(achievement => {
    const div = document.createElement('div');
    div.className = `text-xs p-2 rounded ${achievement.unlocked ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'}`;
    div.innerHTML = `
      <div class="font-medium">${achievement.unlocked ? '🏆' : '🔒'} ${achievement.name}</div>
      <div class="text-xs opacity-75">${achievement.desc}</div>
    `;
    achievementsDiv.appendChild(div);
  });
}

/* ----------------- 画面更新 ----------------- */
function renderStats() {
  statsDiv.innerHTML = `
    <div><span class="font-medium">コイン:</span> <span class="font-bold text-yellow-600">${coins.toLocaleString()}</span></div>
    <div><span class="font-medium">攻撃力:</span> <span class="font-bold text-red-600">${dps}/秒</span></div>
    <div><span class="font-medium">クリティカル率:</span> <span class="font-bold text-yellow-600">${critRate}%</span></div>
    <div><span class="font-medium">防御力:</span> <span class="font-bold text-blue-600">${defense}</span></div>
    <div><span class="font-medium">レベル:</span> <span class="font-bold text-purple-600">${playerLevel}</span></div>
    <div><span class="font-medium">撃破数:</span> <span class="font-bold text-gray-600">${killCount}</span></div>
  `;
  
  // 経験値バー
  const expPercent = (playerExp / playerExpMax) * 100;
  expBar.style.width = expPercent + '%';
  expText.textContent = `${playerExp}/${playerExpMax}`;
  
  // コスト更新
  document.getElementById('attackCost').textContent = attackCost;
  document.getElementById('critCost').textContent = critCost;
  document.getElementById('defenseCost').textContent = defenseCost;
  
  // ボタンの有効/無効
  document.getElementById('upgradeAttack').disabled = coins < attackCost;
  document.getElementById('upgradeCrit').disabled = coins < critCost;
  document.getElementById('upgradeDefense').disabled = coins < defenseCost;
}

function renderEnemy() {
  const enemyTypes = ['テストモンスター', 'クイズドラゴン', '数学スライム', '英語ゴブリン', '理科オーク'];
  const currentEnemyType = enemyTypes[Math.floor(killCount / 10) % enemyTypes.length];
  
  enemyName.textContent = `${currentEnemyType} Lv.${Math.floor(killCount / 5) + 1}`;
  
  const hpPercent = (enemyHP / enemyHPMax) * 100;
  hpBar.style.width = hpPercent + '%';
  
  // HPバーの色変更
  if (hpPercent > 60) {
    hpBar.style.background = 'linear-gradient(90deg, #10b981, #059669)';
  } else if (hpPercent > 30) {
    hpBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
  } else {
    hpBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
  }
  
  document.getElementById('enemyStats').textContent = `HP: ${enemyHP}/${enemyHPMax}`;
}

/* ----------------- バトルループ ----------------- */
setInterval(() => {
  // クリティカル判定
  const isCrit = Math.random() * 100 < critRate;
  const damage = isCrit ? dps * 2 : dps;
  
  enemyHP -= damage;
  
  // ダメージ表示
  const enemyElement = document.getElementById('enemyInfo');
  const rect = enemyElement.getBoundingClientRect();
  createParticle(
    isCrit ? `CRIT! -${damage}` : `-${damage}`,
    isCrit ? '#f59e0b' : '#ef4444',
    rect.left + rect.width / 2,
    rect.top
  );
  
  if (isCrit) {
    enemyElement.classList.add('shake');
    setTimeout(() => enemyElement.classList.remove('shake'), 500);
  }
  
  playSound('attack');
  
  if (enemyHP <= 0) {
    // 敵撃破
    const coinReward = 50 + Math.floor(killCount / 10) * 25;
    const expReward = 20 + Math.floor(killCount / 5) * 5;
    
    coins += coinReward;
    gainExp(expReward);
    killCount++;
    
    // 新しい敵生成
    enemyHPMax = Math.round(enemyHPMax * 1.15);
    enemyHP = enemyHPMax;
    
    // リワード表示
    createParticle(`+${coinReward} コイン`, '#f59e0b', window.innerWidth / 2 - 50, window.innerHeight / 2 + 50);
    createParticle(`+${expReward} EXP`, '#8b5cf6', window.innerWidth / 2 + 50, window.innerHeight / 2 + 50);
    
    playSound('coin');
    
    // ボス戦判定
    if (killCount % 50 === 0) {
      enemyHPMax *= 3;
      enemyHP = enemyHPMax;
      showNotification('ボス出現！');
    }
  }
  
  // クイズタイマー
  if (++quizTimer >= 20) {
    quizTimer = 0;
    openQuiz();
  }
  
  checkAchievements();
  renderStats();
  renderEnemy();
  renderAchievements();
}, 1000);

/* ----------------- 強化ボタン ----------------- */
document.getElementById('upgradeAttack').onclick = () => {
  if (coins >= attackCost) {
    coins -= attackCost;
    dps += 15;
    attackCost = Math.floor(attackCost * 1.5);
    playSound('levelup');
    createParticle('攻撃力UP!', '#ef4444', window.innerWidth / 2, window.innerHeight / 3);
    renderStats();
  }
};

document.getElementById('upgradeCrit').onclick = () => {
  if (coins >= critCost) {
    coins -= critCost;
    critRate += 5;
    critCost = Math.floor(critCost * 1.8);
    playSound('levelup');
    createParticle('クリティカル率UP!', '#f59e0b', window.innerWidth / 2, window.innerHeight / 3);
    renderStats();
  }
};

document.getElementById('upgradeDefense').onclick = () => {
  if (coins >= defenseCost) {
    coins -= defenseCost;
    defense += 10;
    defenseCost = Math.floor(defenseCost * 1.6);
    playSound('levelup');
    createParticle('防御力UP!', '#3b82f6', window.innerWidth / 2, window.innerHeight / 3);
    renderStats();
  }
};

/* ----------------- 音楽コントロール ----------------- */
document.getElementById('musicToggle').onclick = () => {
  musicEnabled = !musicEnabled;
  document.getElementById('musicToggle').textContent = musicEnabled ? '🎵' : '🔇';
};

document.getElementById('sfxToggle').onclick = () => {
  sfxEnabled = !sfxEnabled;
  document.getElementById('sfxToggle').textContent = sfxEnabled ? '🔊' : '🔇';
};

/* ----------------- クイズモーダル ----------------- */
function openQuiz() {
  if (quizPool.length === 0) quizPool = todaysQuizPool();
  const quiz = quizPool.pop();
  
  const modal = document.getElementById('quizModal');
  const qEl = document.getElementById('quizQ');
  const optDiv = document.getElementById('quizOptions');
  const msg = document.getElementById('quizMsg');
  const close = document.getElementById('quizClose');
  const timerCircle = document.getElementById('quizTimer');
  
  qEl.textContent = quiz.q;
  optDiv.innerHTML = '';
  msg.textContent = '';
  close.classList.add('hidden');
  
  // タイマー初期化
  quizTimeLeft = 30;
  const timerInterval = setInterval(() => {
    quizTimeLeft--;
    const progress = (30 - quizTimeLeft) / 30;
    const offset = 175.929 * (1 - progress);
    timerCircle.style.strokeDashoffset = offset;
    
    if (quizTimeLeft <= 0) {
      clearInterval(timerInterval);
      msg.textContent = '時間切れ！';
      msg.style.color = '#ef4444';
      [...optDiv.children].forEach(b => b.disabled = true);
      close.classList.remove('hidden');
      playSound('wrong');
    }
  }, 1000);
  
  quiz.opts.forEach((txt, i) => {
    const btn = document.createElement('button');
    btn.textContent = txt;
    btn.className = 'w-full px-4 py-3 bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white rounded-lg transition-all duration-300 font-medium';
    btn.onclick = () => {
      clearInterval(timerInterval);
      if (i === quiz.ans) {
        msg.textContent = '🎉 正解！コイン+150、EXP+30';
        msg.style.color = '#10b981';
        coins += 150;
        gainExp(30);
        playSound('correct');
        
        // 正解数カウント
        let correctCount = parseInt(localStorage.getItem('quizCorrect') || '0');
        correctCount++;
        localStorage.setItem('quizCorrect', correctCount);
        
        createParticle('+150 コイン', '#f59e0b', window.innerWidth / 2 - 50, window.innerHeight / 2);
        createParticle('+30 EXP', '#8b5cf6', window.innerWidth / 2 + 50, window.innerHeight / 2);
      } else {
        msg.textContent = '❌ 残念...正解は「' + quiz.opts[quiz.ans] + '」でした';
        msg.style.color = '#ef4444';
        playSound('wrong');
      }
      renderStats();
      [...optDiv.children].forEach(b => b.disabled = true);
      close.classList.remove('hidden');
    };
    optDiv.appendChild(btn);
  });
  
  close.onclick = () => {
    clearInterval(timerInterval);
    modal.classList.remove('show');
  };
  
  modal.classList.add('show');
}

/* ----------------- 初期化 ----------------- */
function initGame() {
  // ローカルストレージから正解数を取得
  if (!localStorage.getItem('quizCorrect')) {
    localStorage.setItem('quizCorrect', '0');
  }
  
  renderStats();
  renderEnemy();
  renderAchievements();
  
  // 開始時のウェルカムメッセージ
  setTimeout(() => {
    showNotification('JUKEN★QUEST へようこそ！');
  }, 1000);
  
  // 背景音楽のシミュレーション（実際の音楽ファイルがない場合）
  if (musicEnabled) {
    console.log('🎵 BGM playing...');
  }
}

/* ----------------- キーボードショートカット ----------------- */
document.addEventListener('keydown', (e) => {
  switch(e.key) {
    case '1':
      if (coins >= attackCost) document.getElementById('upgradeAttack').click();
      break;
    case '2':
      if (coins >= critCost) document.getElementById('upgradeCrit').click();
      break;
    case '3':
      if (coins >= defenseCost) document.getElementById('upgradeDefense').click();
      break;
    case 'm':
    case 'M':
      document.getElementById('musicToggle').click();
      break;
    case 's':
    case 'S':
      document.getElementById('sfxToggle').click();
      break;
    case 'Escape':
      const modal = document.getElementById('quizModal');
      if (modal.classList.contains('show')) {
        document.getElementById('quizClose').click();
      }
      break;
  }
});

/* ----------------- 追加のゲーム機能 ----------------- */

// オートセーブ機能
setInterval(() => {
  const gameData = {
    coins,
    dps,
    critRate,
    defense,
    playerLevel,
    playerExp,
    playerExpMax,
    killCount,
    attackCost,
    critCost,
    defenseCost
  };
  localStorage.setItem('jukenQuestSave', JSON.stringify(gameData));
}, 10000); // 10秒ごとにセーブ

// ゲームロード機能
function loadGame() {
  const savedData = localStorage.getItem('jukenQuestSave');
  if (savedData) {
    try {
      const data = JSON.parse(savedData);
      coins = data.coins || 0;
      dps = data.dps || 10;
      critRate = data.critRate || 5;
      defense = data.defense || 0;
      playerLevel = data.playerLevel || 1;
      playerExp = data.playerExp || 0;
      playerExpMax = data.playerExpMax || 100;
      killCount = data.killCount || 0;
      attackCost = data.attackCost || 100;
      critCost = data.critCost || 200;
      defenseCost = data.defenseCost || 150;
      
      // 敵のHPも調整
      enemyHPMax = 100 + (killCount * 15);
      enemyHP = enemyHPMax;
      
      showNotification('前回のデータを読み込みました！');
    } catch (e) {
      console.log('セーブデータの読み込みに失敗しました');
    }
  }
}

// リセット機能（隠し機能）
function resetGame() {
  if (confirm('本当にゲームをリセットしますか？全ての進行状況が失われます。')) {
    localStorage.removeItem('jukenQuestSave');
    localStorage.removeItem('quizCorrect');
    location.reload();
  }
}

// デバッグ用コンソールコマンド
window.addCoins = (amount) => {
  coins += amount;
  renderStats();
  console.log(`${amount} コインを追加しました`);
};

window.addLevel = (levels) => {
  for (let i = 0; i < levels; i++) {
    gainExp(playerExpMax);
  }
  console.log(`${levels} レベル追加しました`);
};

window.resetGameData = resetGame;

// 右クリックでリセットメニュー（隠し機能）
document.addEventListener('contextmenu', (e) => {
  if (e.ctrlKey && e.shiftKey) {
    e.preventDefault();
    if (confirm('隠しリセットメニュー\nゲームをリセットしますか？')) {
      resetGame();
    }
  }
});

// タッチデバイス対応
let touchStartY = 0;
document.addEventListener('touchstart', (e) => {
  touchStartY = e.touches[0].clientY;
});

document.addEventListener('touchend', (e) => {
  const touchEndY = e.changedTouches[0].clientY;
  const diff = touchStartY - touchEndY;
  
  // 上スワイプでクイズを強制開始（隠し機能）
  if (diff > 100) {
    openQuiz();
  }
});

// ウィンドウフォーカス時の処理
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    // ページに戻ってきた時の処理
    renderStats();
    renderEnemy();
    renderAchievements();
  }
});

// ゲーム開始
loadGame();
initGame();

// コンソールメッセージ
console.log('%c🎮 JUKEN★QUEST Enhanced Edition', 'color: #10b981; font-size: 20px; font-weight: bold;');
console.log('%c開発者向けコマンド:', 'color: #3b82f6; font-size: 14px; font-weight: bold;');
console.log('%caddCoins(amount) - コインを追加', 'color: #6b7280;');
console.log('%caddLevel(levels) - レベルを追加', 'color: #6b7280;');
console.log('%cresetGameData() - ゲームリセット', 'color: #6b7280;');
console.log('%cキーボードショートカット: 1,2,3=強化, M=音楽, S=効果音, ESC=モーダル閉じる', 'color: #6b7280;');
</script>
</body>
</html>